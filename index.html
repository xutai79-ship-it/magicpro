<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K12ç¼–ç¨‹ - å¥‡å¼‚åšå£«ï¼šHTTPé˜²å¼¹ä¿®å¤ç‰ˆ</title>
    
    <style>
        /* åŸºç¡€é‡ç½® */
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        video { display: none; } /* è§†é¢‘æºéšè—ï¼Œæˆ‘ä»¬åªç”»Canvas */

        /* å¯åŠ¨é®ç½©ä¸é”™è¯¯æç¤º */
        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .title-text { color: #ffaa00; font-size: 24px; font-weight: 900; letter-spacing: 4px; text-shadow: 0 0 20px #ff5500; margin-bottom: 20px; }
        .btn-start {
            padding: 12px 30px; border: 2px solid #ffaa00; color: #ffaa00; background: transparent;
            font-size: 18px; font-weight: bold; border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.3); transition: all 0.3s; margin-top: 20px;
        }
        .btn-start:active { transform: scale(0.95); background: rgba(255, 170, 0, 0.2); }
        .env-warning {
            color: #ff4444; font-size: 12px; margin-top: 10px; padding: 5px 10px;
            border: 1px solid #ff4444; border-radius: 4px; background: rgba(50,0,0,0.5); display: none;
        }
        
        /* UI å±‚ */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 30px;
        }
        .hud-panel {
            background: rgba(20, 5, 0, 0.85); border: 2px solid rgba(255, 180, 0, 0.5);
            border-radius: 40px; padding: 10px 20px; text-align: center;
            box-shadow: 0 0 80px rgba(255, 120, 0, 0.4); transform: scale(0.9); pointer-events: auto;
        }
        .control-group { display: inline-flex; flex-direction: column; align-items: center; margin: 0 5px; }
        .group-label { font-size: 10px; color: #aaa; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .key-badge {
            display: inline-block; width: 30px; height: 30px; line-height: 30px; border-radius: 8px; margin: 0 2px; 
            color: #fff; background: rgba(255,255,255,0.1); font-weight: 900; font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer;
        }
        .mode-active { background: #ffcc00; color: #000; box-shadow: 0 0 15px #ff8800; border-color: #fff; }
        .sub-active { background: #00eaff; color: #000; box-shadow: 0 0 15px #00eaff; border-color: #fff; }
        .bg-active { background: #ff3333; color: #fff; border-color: #fff; }
        .status-text { color: #fff; font-size: 14px; margin-top: 8px; display: block; font-weight: 700; }
        .divider { display: inline-block; width: 1px; height: 25px; background: rgba(255,255,255,0.2); margin: 0 5px; vertical-align: middle; }
    </style>

    <script>
        (function() {
            // 1. å®‰å…¨ç¯å¢ƒæ£€æµ‹
            var isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            var isHttps = location.protocol === 'https:';
            window.IS_SECURE = isHttps || isLocal; // å…¨å±€å®‰å…¨æ ‡å¿—
            
            // 2. é”™è¯¯é™é»˜å¤„ç† (é˜²æ­¢å¼¹çº¢çª—)
            window.onerror = function(msg) {
                if (msg.indexOf('buffer') > -1 || msg.indexOf('packed_assets') > -1) {
                    console.warn("MediaPipe åŠ è½½è¢«æ‹¦æˆªï¼Œè‡ªåŠ¨åˆ‡æ¢é™çº§æ¨¡å¼");
                    return true; // é˜»æ­¢æŠ¥é”™å‘ä¸Šå†’æ³¡
                }
            };

            // 3. è®¾å¤‡æ€§èƒ½ç”»åƒ
            var cores = navigator.hardwareConcurrency || 4;
            var isLowEnd = cores <= 4 || /Android|iPhone/i.test(navigator.userAgent);
            window.GAME_CONFIG = {
                tier: isLowEnd ? 'LOW' : 'HIGH',
                maxParticles: isLowEnd ? 800 : 2500, // ç²’å­æ•°é™åˆ¶
                shadows: !isLowEnd // ä½ç«¯æœºå…³é˜´å½±
            };
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="splash-screen">
        <div class="title-text">MAGIC AR CORE</div>
        <div id="loading-text" style="color:#888; font-size:12px;">æ­£åœ¨æ£€æµ‹ç¯å¢ƒå®‰å…¨åè®®...</div>
        <div id="env-warning" class="env-warning"></div>
        <button id="btn-start" class="btn-start" style="display:none">å¯åŠ¨ç³»ç»Ÿ</button>
    </div>

    <video id="input_video" playsinline webkit-playsinline></video>
    <canvas id="output_canvas"></canvas>

    <div id="ui-layer">
        <div class="hud-panel">
            <div style="display:flex; align-items:center; justify-content:center;">
                <div class="control-group">
                    <span class="group-label">Mode</span>
                    <div>
                        <span id="k1" class="key-badge mode-active">1</span>
                        <span id="k2" class="key-badge">2</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Style</span>
                    <div>
                        <span id="k3" class="key-badge sub-active">3</span>
                        <span id="k4" class="key-badge">4</span>
                        <span id="k5" class="key-badge">5</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Color</span>
                    <div>
                        <span id="kq" class="key-badge mode-active">Q</span>
                        <span id="kw" class="key-badge">W</span>
                        <span id="ke" class="key-badge">E</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">BG</span>
                    <div><span id="k0" class="key-badge">CAM</span></div>
                </div>
            </div>
            <span id="instruction-text" class="status-text">SYSTEM READY</span>
        </div>
    </div>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d', { alpha: false }); // ä¼˜åŒ–æ€§èƒ½
    const instructionText = document.getElementById('instruction-text');
    
    // å…¨å±€çŠ¶æ€
    let canvasW, canvasH, globalTime = 0;
    let isRunning = false;
    let useMouseFallback = false; // æ˜¯å¦ä½¿ç”¨é¼ æ ‡é™çº§æ¨¡å¼
    
    const MODE = { STAGE_1: 1, STAGE_2: 2 };
    let appState = { mode: 1, shape: 0, color: 0, particleType: 0, bgBlack: false };
    
    // é¼ æ ‡æ¨¡æ‹Ÿæ•°æ®
    let mouseHand = { x: 0.5, y: 0.5, active: false };
    let handsResults = []; // æœ€ç»ˆç»Ÿä¸€çš„æ‰‹éƒ¨æ•°æ® [{x,y,scale}]

    // èµ„æºæ± 
    const cachedAssets = {};
    const particlePool = [];
    const sparks = [];
    let s2Data = { state: 'IDLE', rotX: 0, rotY: 0, cd: 0, startT: 0 };

    // é…ç½®æ•°æ® (ä¿ç•™ä½ çš„æ–‡æ¡ˆ)
    const RUNES = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const THEMES = [
        { name: "å¥‡å¼‚é‡‘", hue: 35,  glow: '#ffaa00', text: 'rgba(255, 200, 100, 1)' },
        { name: "é‡å­è“", hue: 190, glow: '#00eaff', text: 'rgba(100, 240, 255, 1)' },
        { name: "çŒ©çº¢ç…", hue: 0,   glow: '#ff2200', text: 'rgba(255, 100, 100, 1)' }
    ];
    const PARTICLE_TEXTS = [
        { t1: "è€çˆ¸ï¼Œåˆšå¹äº†ä¸€é˜µé£", t2: "æ˜¯è€çˆ¸çš„ç‰æ ‘ä¸´é£ ğŸ•¶ï¸" },
        { t1: "å®‡å®™æµ©ç€šæ— å ", t2: "å”¯ä½ æœ€ä¸ºé—ªè€€ âœ¨" },
        { t1: "é€ä½ ä¸€æœµèŠ±...", t2: "éšä¾¿èŠ± ğŸŒ¸" }
    ];

    // --- 1. åˆå§‹åŒ–æµç¨‹ (å…³é”®ä¿®å¤ç‚¹) ---
    function initApp() {
        const btn = document.getElementById('btn-start');
        const warning = document.getElementById('env-warning');
        const loading = document.getElementById('loading-text');

        // ç¯å¢ƒæ£€æµ‹é€»è¾‘
        if (!window.IS_SECURE) {
            // HTTP ç¯å¢ƒï¼šç›´æ¥é™çº§ï¼Œä¸å°è¯•åŠ è½½ MediaPipe
            warning.style.display = 'block';
            warning.innerHTML = "âš ï¸ æ£€æµ‹åˆ° HTTP ä¸å®‰å…¨ç¯å¢ƒ<br>æ‘„åƒå¤´å·²ç¦ç”¨ï¼Œè‡ªåŠ¨åˆ‡æ¢è‡³è§¦æ‘¸/é¼ æ ‡æ¨¡å¼";
            loading.innerText = "é™çº§æ¨¡å¼å·²å°±ç»ª";
            useMouseFallback = true;
            appState.bgBlack = true; // æ²¡æ‘„åƒå¤´é»˜è®¤é»‘åº•
            btn.innerText = "å¯åŠ¨è§¦æ‘¸æ¨¡å¼";
        } else {
            // HTTPS ç¯å¢ƒï¼šæ­£å¸¸æµç¨‹
            loading.innerText = "ç¯å¢ƒå®‰å…¨ï¼Œå‡†å¤‡åŠ è½½ AI æ ¸å¿ƒ...";
            btn.innerText = "å¯åŠ¨é­”æ³•å¼•æ“";
        }
        
        btn.style.display = 'block';
        
        // é¢„ç”Ÿæˆ Canvas ç¼“å­˜
        resize();
        generateCache();
        initParticles();

        btn.onclick = function() {
            document.getElementById('splash-screen').style.display = 'none';
            isRunning = true;
            
            if (useMouseFallback) {
                startFallbackMode();
            } else {
                startCameraMode();
            }
            // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            requestAnimationFrame(renderLoop);
        };
    }

    // --- 2. æ¨¡å¼å¯åŠ¨å™¨ ---

    function startFallbackMode() {
        // ç»‘å®šé¼ æ ‡/è§¦æ‘¸äº‹ä»¶
        window.addEventListener('mousemove', e => {
            mouseHand.x = e.clientX / canvasW;
            mouseHand.y = e.clientY / canvasH;
            mouseHand.active = true;
        });
        window.addEventListener('touchmove', e => {
            e.preventDefault();
            mouseHand.x = e.touches[0].clientX / canvasW;
            mouseHand.y = e.touches[0].clientY / canvasH;
            mouseHand.active = true;
        }, {passive: false});
        
        instructionText.innerText = "è§¦æ‘¸å±å¹•ä»¥é‡Šæ”¾é­”æ³•";
        updateUI();
    }

    function startCameraMode() {
        // å°è¯•å¯åŠ¨æ‘„åƒå¤´
        const constraints = { audio: false, video: { facingMode: 'user', width: 1280, height: 720 } };
        
        // Promise é“¾å¼è°ƒç”¨é¿å… async/await å…¼å®¹æ€§é—®é¢˜
        navigator.mediaDevices.getUserMedia(constraints).then(stream => {
            videoElement.srcObject = stream;
            videoElement.play();
            initMediaPipe();
        }).catch(err => {
            console.error("Camera Error:", err);
            alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œåˆ‡æ¢è‡³è§¦æ‘¸æ¨¡å¼");
            useMouseFallback = true;
            appState.bgBlack = true;
            startFallbackMode();
        });
    }

    function initMediaPipe() {
        try {
            // å…³é”®ï¼šæ‰‹åŠ¨æŒ‡å®š locateFileï¼Œé˜²æ­¢ loading 'undefined' path
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`;
            }});
            
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onMediaPipeResults);
            
            // ä½¿ç”¨è‡ªå®šä¹‰å¸§å¾ªç¯å‘é€æ•°æ®ï¼Œæ¯” CameraUtils æ›´å¯æ§
            function sendFrame() {
                if (!videoElement.paused && !videoElement.ended) {
                    hands.send({image: videoElement}).catch(err => {
                        // æ•è· buffer é”™è¯¯ï¼Œé™çº§
                        console.error("MP Error", err);
                    });
                }
                if(isRunning) requestAnimationFrame(sendFrame);
            }
            sendFrame();
            
        } catch (e) {
            console.error("MediaPipe Init Failed", e);
            useMouseFallback = true;
            startFallbackMode();
        }
    }

    // --- 3. æ•°æ®å¤„ç†ä¸æ¸²æŸ“ ---

    function onMediaPipeResults(results) {
        // ä»…åœ¨æ‘„åƒå¤´æ¨¡å¼ä¸‹æ›´æ–°æ•°æ®
        if (useMouseFallback) return;

        // ç»˜åˆ¶èƒŒæ™¯
        if (!appState.bgBlack) {
            canvasCtx.drawImage(results.image, 0, 0, canvasW, canvasH);
            canvasCtx.fillStyle = 'rgba(0,0,0,0.6)'; // å‹æš—è§†é¢‘
            canvasCtx.fillRect(0,0, canvasW, canvasH);
        }

        // æå–æ‰‹åŠ¿
        handsResults = [];
        if (results.multiHandLandmarks) {
            for (const landmarks of results.multiHandLandmarks) {
                // ç®€å•çš„æ·±åº¦æ˜ å°„
                const size = Math.abs(landmarks[5].x - landmarks[17].x);
                const scale = Math.max(0.5, Math.min(2.0, size / 0.1));
                handsResults.push({
                    x: landmarks[9].x * canvasW,
                    y: landmarks[9].y * canvasH,
                    scale: scale
                });
            }
        }
    }

    function renderLoop() {
        globalTime++;
        
        // æ¸…å±é€»è¾‘
        if (appState.bgBlack || useMouseFallback) {
            canvasCtx.fillStyle = '#000';
            canvasCtx.fillRect(0, 0, canvasW, canvasH);
        }

        // å¦‚æœæ˜¯é™çº§æ¨¡å¼ï¼Œæ‰‹åŠ¨æ„é€ æ•°æ®
        if (useMouseFallback && mouseHand.active) {
            handsResults = [{
                x: mouseHand.x * canvasW,
                y: mouseHand.y * canvasH,
                scale: 1.2
            }];
        }

        // ç»˜åˆ¶ç‰¹æ•ˆ
        drawEffects();

        if (isRunning) requestAnimationFrame(renderLoop);
    }

    // --- 4. ç‰¹æ•ˆç»˜åˆ¶é€»è¾‘ (å¤åˆ»ä½ çš„åŸç‰ˆé€»è¾‘) ---
    
    function drawEffects() {
        const t = globalTime * 0.02;
        const theme = THEMES[appState.color];
        
        canvasCtx.globalCompositeOperation = 'lighter';

        // Stage 1: æ³•é˜µè·Ÿéš
        if (appState.mode === 1) {
            handsResults.forEach(hand => {
                const s = hand.scale;
                const x = hand.x; const y = hand.y;
                
                if (appState.shape === 0) { // æ›¼é™€ç½—
                    drawCache('mandala_outer', x, y, -t*0.5, s*1.0, 0.8);
                    drawCache('mandala_inner', x, y, t, s*0.7, 1.0);
                    drawCache('runes', x, y, -t*0.2, s*0.5, 0.9);
                } else if (appState.shape === 1) { // ç§‘æŠ€
                    drawCache('tech_ring', x, y, t, s*1.1, 0.8);
                    drawCache('tech_core', x, y, -t*2, s*0.6, 1.0);
                } else { // æ··æ²Œ
                    drawCache('chaos_1', x, y, t*2, s*1.2, 0.6);
                    drawCache('chaos_2', x, y, -t, s*0.8, 0.7);
                }
            });
            
            if (handsResults.length === 0) {
                instructionText.innerText = useMouseFallback ? "è§¦æ‘¸å±å¹•æ¿€æ´»" : "è¯·ä¼¸å‡ºæ‰‹";
            } else {
                instructionText.innerText = "æ³•é˜µæ¿€æ´»";
            }
        }
        
        // Stage 2: ç²’å­å¬å”¤
        else {
            const hasHands = handsResults.length >= (useMouseFallback ? 1 : 2);
            const cx = canvasW/2; const cy = canvasH/2;
            
            // ç®€å•çš„çŠ¶æ€æœº
            if (s2Data.state === 'IDLE' && hasHands) {
                s2Data.state = 'STABLE';
                // å‘å°„ç²’å­
                const limit = window.GAME_CONFIG.maxParticles;
                for(let i=0; i<limit; i++) particlePool[i].spawn(appState.particleType);
            } else if (s2Data.state === 'STABLE' && !hasHands) {
                s2Data.state = 'DISPERSE';
                s2Data.startT = Date.now();
            }

            if (s2Data.state !== 'IDLE') {
                const isDisperse = s2Data.state === 'DISPERSE';
                let alpha = 1.0;
                
                if (isDisperse) {
                    const elapsed = Date.now() - s2Data.startT;
                    if (elapsed > 3000) alpha = 1 - (elapsed-3000)/1000;
                    if (elapsed > 4000) s2Data.state = 'IDLE';
                }

                // æ›´æ–°å¹¶ç»˜åˆ¶ç²’å­
                canvasCtx.fillStyle = theme.glow;
                const limit = window.GAME_CONFIG.maxParticles;
                
                for(let i=0; i<limit; i++) {
                    const p = particlePool[i];
                    p.update(isDisperse);
                    if (p.active) {
                        const fl = 400; const scale = fl / (fl + p.z + 500);
                        if (scale > 0) {
                            canvasCtx.globalAlpha = alpha;
                            canvasCtx.fillRect(cx + p.x*scale, cy + p.y*scale, p.size*scale, p.size*scale);
                        }
                    }
                }
                
                // æ–‡å­—ç»˜åˆ¶
                canvasCtx.globalAlpha = alpha;
                canvasCtx.font = "bold 24px sans-serif";
                canvasCtx.fillStyle = "#fff";
                canvasCtx.textAlign = "center";
                const txt = PARTICLE_TEXTS[appState.particleType];
                
                if (s2Data.state === 'STABLE') canvasCtx.fillText(txt.t1, cx, cy - 250);
                else if (isDisperse) {
                    canvasCtx.font = "bold 36px sans-serif";
                    canvasCtx.fillText(txt.t2, cx, cy);
                }
            }
            instructionText.innerText = s2Data.state === 'IDLE' ? "åŒæ‰‹åˆæ‹¢å¬å”¤" : "";
        }
        
        canvasCtx.globalCompositeOperation = 'source-over';
    }

    // --- 5. è¾…åŠ©ç³»ç»Ÿ (Cache, Particle, Event) ---

    function createCache(size) {
        const c = document.createElement('canvas'); c.width = size; c.height = size;
        return { c: c, ctx: c.getContext('2d'), size: size, half: size/2 };
    }
    
    // ç®€åŒ–çš„ç»˜åˆ¶è¾…åŠ©å‡½æ•° (ä¿è¯ä¸æŠ¥é”™)
    function drawCache(key, x, y, rot, scale, alpha) {
        if (!cachedAssets[key]) return;
        const obj = cachedAssets[key];
        canvasCtx.save();
        canvasCtx.translate(x, y); canvasCtx.rotate(rot); canvasCtx.globalAlpha = alpha;
        canvasCtx.drawImage(obj.c, -obj.half*scale, -obj.half*scale, obj.size*scale, obj.size*scale);
        canvasCtx.restore();
    }

    function generateCache() {
        const theme = THEMES[appState.color];
        const shadow = window.GAME_CONFIG.shadows;
        
        // é€šç”¨ç»˜åˆ¶å™¨
        const make = (key, size, drawFn) => {
            const o = createCache(size);
            const ctx = o.ctx; ctx.translate(size/2, size/2);
            if(shadow) { ctx.shadowBlur = 15; ctx.shadowColor = theme.glow; }
            ctx.strokeStyle = theme.text; ctx.fillStyle = theme.text;
            drawFn(ctx);
            cachedAssets[key] = o;
        };

        // 1. æ›¼é™€ç½—å¤–åœˆ
        make('mandala_outer', 500, (ctx) => {
            ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(0,0, 240, 0, Math.PI*2); ctx.stroke();
            ctx.font = "20px monospace"; ctx.textAlign = "center";
            for(let i=0; i<24; i++) {
                ctx.save(); ctx.rotate(i/24 * Math.PI*2); ctx.fillText(RUNES[i%RUNES.length], 0, -210); ctx.restore();
            }
        });
        
        // 2. å†…åœˆ
        make('mandala_inner', 400, (ctx) => {
            ctx.lineWidth = 2; 
            for(let i=0; i<6; i++) {
                ctx.save(); ctx.rotate(i/6*Math.PI*2); ctx.strokeRect(-100,-100,200,200); ctx.restore();
            }
        });

        // 3. ç¬¦æ–‡
        make('runes', 300, (ctx) => {
            ctx.beginPath(); ctx.arc(0,0, 100, 0, Math.PI*2); ctx.stroke();
        });

        // 4. ç§‘æŠ€åœˆ
        make('tech_ring', 500, (ctx) => {
            ctx.lineWidth = 5; ctx.beginPath(); ctx.arc(0,0, 220, 0, Math.PI*2); ctx.stroke();
            for(let i=0; i<4; i++) {
                ctx.save(); ctx.rotate(i*Math.PI/2); ctx.beginPath(); ctx.moveTo(220,0); ctx.lineTo(250,0); ctx.stroke(); ctx.restore();
            }
        });

        // 5. ç§‘æŠ€æ ¸
        make('tech_core', 300, (ctx) => {
            ctx.beginPath(); ctx.moveTo(0,-100); ctx.lineTo(80,50); ctx.lineTo(-80,50); ctx.closePath(); ctx.stroke();
        });

        // 6. æ··æ²Œ
        make('chaos_1', 400, (ctx) => {
            ctx.beginPath(); 
            for(let i=0; i<20; i++) { ctx.rotate(0.5); ctx.lineTo(150,0); ctx.translate(10,0); }
            ctx.stroke();
        });
        make('chaos_2', 300, (ctx) => { ctx.beginPath(); ctx.arc(0,0,100,0,Math.PI*2); ctx.stroke(); });
    }

    // ç²’å­ç³»ç»Ÿ
    class Particle {
        constructor() { this.active = false; }
        spawn(type) {
            this.active = true;
            this.x = 0; this.y = 0; this.z = 0;
            this.vx = (Math.random()-0.5)*10; this.vy = (Math.random()-0.5)*10; this.vz = (Math.random()-0.5)*10;
            this.size = Math.random()*5 + 2;
            
            // ç®€å•å½¢çŠ¶é€»è¾‘
            const r = 200; 
            const theta = Math.random()*Math.PI*2;
            if(type === 0) { // Heart
                this.tx = 16 * Math.pow(Math.sin(theta), 3) * 10;
                this.ty = -(13*Math.cos(theta)-5*Math.cos(2*theta)) * 10;
                this.tz = (Math.random()-0.5)*100;
            } else if (type === 1) { // Sphere
                 const phi = Math.random()*Math.PI;
                 this.tx = r*Math.sin(phi)*Math.cos(theta);
                 this.ty = r*Math.sin(phi)*Math.sin(theta);
                 this.tz = r*Math.cos(phi);
            } else { // Flower
                 this.tx = r*Math.cos(theta); this.ty = r*Math.sin(theta); this.tz = (Math.random()-0.5)*200;
            }
            this.ty -= 100; // Lift up
        }
        update(isDisperse) {
            if(!this.active) return;
            if(isDisperse) {
                this.x+=this.vx; this.y+=this.vy; this.z+=this.vz;
            } else {
                this.x += (this.tx - this.x)*0.1;
                this.y += (this.ty - this.y)*0.1;
                this.z += (this.tz - this.z)*0.1;
            }
        }
    }

    function initParticles() {
        for(let i=0; i<3000; i++) particlePool.push(new Particle());
    }

    // --- 6. äº‹ä»¶ç»‘å®š ---
    function resize() { canvasW = window.innerWidth; canvasH = window.innerHeight; canvasElement.width = canvasW; canvasElement.height = canvasH; }
    window.addEventListener('resize', resize);

    function updateUI() {
        const set = (id, active, cls) => document.getElementById(id).className = `key-badge ${active?cls:''}`;
        set('k1', appState.mode===1, 'mode-active');
        set('k2', appState.mode===2, 'mode-active');
        const isS1 = appState.mode === 1;
        set('k3', (isS1&&appState.shape===0)||(!isS1&&appState.particleType===0), 'sub-active');
        set('k4', (isS1&&appState.shape===1)||(!isS1&&appState.particleType===1), 'sub-active');
        set('k5', (isS1&&appState.shape===2)||(!isS1&&appState.particleType===2), 'sub-active');
        set('kq', appState.color===0, 'mode-active');
        set('kw', appState.color===1, 'mode-active');
        set('ke', appState.color===2, 'mode-active');
        set('k0', appState.bgBlack, 'bg-active');
        generateCache(); // é¢œè‰²æ”¹å˜éœ€é‡ç»˜
    }

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    const bind = (id, fn) => {
        const el = document.getElementById(id);
        el.onclick = fn; el.ontouchstart = (e) => { e.preventDefault(); fn(); };
    };
    bind('k1', ()=>{appState.mode=1; appState.bgBlack=useMouseFallback; updateUI();});
    bind('k2', ()=>{appState.mode=2; appState.bgBlack=true; s2Data.state='IDLE'; updateUI();});
    
    bind('k3', ()=>{ if(appState.mode===1)appState.shape=0; else {appState.particleType=0;s2Data.state='IDLE';} updateUI();});
    bind('k4', ()=>{ if(appState.mode===1)appState.shape=1; else {appState.particleType=1;s2Data.state='IDLE';} updateUI();});
    bind('k5', ()=>{ if(appState.mode===1)appState.shape=2; else {appState.particleType=2;s2Data.state='IDLE';} updateUI();});
    
    bind('kq', ()=>{appState.color=0; updateUI();});
    bind('kw', ()=>{appState.color=1; updateUI();});
    bind('ke', ()=>{appState.color=2; updateUI();});
    bind('k0', ()=>{appState.bgBlack=!appState.bgBlack; updateUI();});

    // å¯åŠ¨
    initApp();

</script>
</body>
</html>
