<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>K12ç¼–ç¨‹ - å¥‡å¼‚åšå£«ï¼šå…¨åœ°å½¢äº¤ä»˜ç‰ˆ</title>
    
    <script>
        (function() {
            // ã€H5å¤§å¸ˆä¿®å¤ã€‘API Polyfillï¼šç¡®ä¿ requestAnimationFrame å’Œ getUserMedia åœ¨æ—§æµè§ˆå™¨å¯ç”¨
            window.requestAnimFrame = (function(){
                return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame ||
                function(callback) { window.setTimeout(callback, 1000 / 60); };
            })();
            
            // ã€H5å¤§å¸ˆä¿®å¤ã€‘å¼ºåˆ¶ HTTPS æ£€æµ‹ï¼šWebXR/Camera æƒé™åœ¨ HTTP ä¸‹ä¼šè¢«æµè§ˆå™¨ç›´æ¥é˜»æ–­
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert('å®‰å…¨è­¦å‘Šï¼šæ‘„åƒå¤´åŠŸèƒ½éœ€è¦ HTTPS ç¯å¢ƒã€‚\nè¯·é…ç½® SSL è¯ä¹¦æˆ–ä½¿ç”¨ localhost è°ƒè¯•ã€‚');
            }

            // ã€H5å¤§å¸ˆä¿®å¤ã€‘è®¾å¤‡å®šçº§ (Profiler)ï¼šæ ¹æ® UA å’Œ å±å¹•åˆ†è¾¨ç‡å†³å®šæ€§èƒ½ç­–ç•¥
            var ua = navigator.userAgent.toLowerCase();
            var isAndroid = ua.indexOf('android') > -1;
            var isOldIOS = /iphone os [0-9]_/.test(ua); // iOS 9åŠä»¥ä¸‹
            // ç®€å•çš„ä½ç«¯æœºåˆ¤å®šé€»è¾‘ï¼šå±å¹•çª„ æˆ– å®‰å“æ—§ç‰ˆæœ¬ æˆ– æ˜¾å¡å¹¶å‘ä½
            var isLowEnd = (window.innerWidth < 380) || (isAndroid && ua.indexOf('chrome/5') > -1) || (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4);

            window.IS_LOW_END = isLowEnd;

            // ã€H5å¤§å¸ˆä¿®å¤ã€‘é…ç½®æ³¨å…¥ï¼šåŠ¨æ€ç”Ÿæˆé…ç½®å¯¹è±¡
            window.GAME_CONFIG = {
                // ä½ç«¯æœºå…³é—­æ˜‚è´µçš„é˜´å½± blurï¼Œé«˜ç«¯æœºå¼€å¯
                shadowBlur: isLowEnd ? 0 : 20, 
                // ä½ç«¯æœºé™çº§æ¸²æŸ“åˆ†è¾¨ç‡ä¸º 75%ï¼Œå¤§å¹…é™ä½ GPU å¡«å……ç‡å‹åŠ›
                renderScale: isLowEnd ? 0.75 : 1.0, 
                // ç²’å­æ•°é‡åˆ†çº§
                particleCount: isLowEnd ? 800 : 2500,
                // AI æ£€æµ‹é¢‘ç‡ï¼šä½ç«¯æœºæ¯ 3 å¸§æ£€æµ‹ä¸€æ¬¡ï¼Œé«˜ç«¯æœºæ¯ 1 å¸§æ£€æµ‹ä¸€æ¬¡
                aiInterval: isLowEnd ? 3 : 1,
                // æ˜¯å¦ä½¿ç”¨æ¨¡æ‹Ÿé¼ æ ‡ï¼ˆå½“æ‘„åƒå¤´å¤±è´¥æ—¶ï¼‰
                fallbackMode: false
            };
            
            console.log("H5 Master Profiler: Device Tier [" + (isLowEnd ? "LOW" : "HIGH") + "]", window.GAME_CONFIG);
        })();
    </script>

    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        canvas { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* UI Layer Styles */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: constant(safe-area-inset-bottom); /* iOS é€‚é… */
            padding-bottom: env(safe-area-inset-bottom);
            padding-bottom: 30px;
            z-index: 10;
        }

        /* å¯åŠ¨é®ç½©å±‚ï¼šè§£å†³ User Activation Policy */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .start-btn {
            padding: 15px 40px; border: 2px solid #ffaa00; border-radius: 30px;
            color: #ffaa00; font-size: 20px; font-weight: bold; background: rgba(50,20,0,0.5);
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.4);
        }
        .loading-text { margin-top: 20px; color: #666; font-size: 12px; }

        .hud-panel {
            background: rgba(20, 5, 0, 0.85); 
            border: 2px solid rgba(255, 180, 0, 0.5);
            border-radius: 40px;
            padding: 15px 20px; /* ç§»åŠ¨ç«¯å‡å° padding */
            backdrop-filter: blur(10px); /* å…¼å®¹æ€§é™çº§ */
            -webkit-backdrop-filter: blur(10px);
            text-align: center;
            box-shadow: 0 0 40px rgba(255, 120, 0, 0.4);
            transform: scale(0.9); transition: all 0.3s;
            pointer-events: auto;
            max-width: 90%;
        }

        .control-group { display: inline-flex; flex-direction: column; align-items: center; margin: 0 5px; }
        .group-label { font-size: 9px; color: #aaa; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        
        .key-badge {
            display: inline-block; width: 28px; height: 28px; line-height: 28px; border-radius: 6px; margin: 0 1px; 
            color: #fff; background: rgba(255,255,255,0.1); font-weight: 900; font-size: 12px;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: all 0.2s; user-select: none;
        }
        
        .mode-active { background: #ffcc00; color: #000; box-shadow: 0 0 10px #ff8800; border-color: #fff; transform: scale(1.1); }
        .sub-active { background: #00eaff; color: #000; box-shadow: 0 0 10px #00eaff; border-color: #fff; }
        .bg-active { background: #ff3333; color: #fff; box-shadow: 0 0 10px #ff0000; border-color: #fff; }

        .status-text { 
            color: #fff; font-size: 14px; margin-top: 10px; display: block; font-weight: 700; 
            text-shadow: 0 0 10px rgba(255,150,0,0.8); letter-spacing: 1px;
        }
        .divider { display: inline-block; width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 2px; vertical-align: middle; }
        
        /* Loading Spinner */
        #loading-msg { position: absolute; top: 40%; width: 100%; text-align: center; color: #ffaa00; font-weight: bold; display: none;}
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="start-overlay">
        <div id="btn-start" class="start-btn">ç‚¹å‡»å¼€å¯é­”æ³•</div>
        <div class="loading-text">éœ€æˆæƒæ‘„åƒå¤´æƒé™</div>
    </div>
    
    <div id="loading-msg">æ­£åœ¨åˆå§‹åŒ–ç¥ç»æ ¸å¿ƒ...</div>

    <video id="input_video" style="display:none" playsinline webkit-playsinline></video>
    <canvas id="output_canvas"></canvas>
    
    <div id="ui-layer">
        <div class="hud-panel">
            <div style="display:flex; align-items:center; justify-content:center; flex-wrap: wrap;">
                <div class="control-group">
                    <span class="group-label">Mode</span>
                    <div>
                        <span id="k1" class="key-badge mode-active">1</span>
                        <span id="k2" class="key-badge">2</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Style</span>
                    <div>
                        <span id="k3" class="key-badge sub-active">3</span>
                        <span id="k4" class="key-badge">4</span>
                        <span id="k5" class="key-badge">5</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Color</span>
                    <div>
                        <span id="kq" class="key-badge mode-active">Q</span>
                        <span id="kw" class="key-badge">W</span>
                        <span id="ke" class="key-badge">E</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">BG</span>
                    <div><span id="k0" class="key-badge">CAM</span></div>
                </div>
            </div>
            <span id="instruction-text" class="status-text">WAITING FOR INPUT...</span>
        </div>
    </div>

<script>
    // === æ ¸å¿ƒå˜é‡å®šä¹‰ ===
    var videoElement = document.getElementById('input_video');
    var canvasElement = document.getElementById('output_canvas');
    var canvasCtx = canvasElement.getContext('2d', { alpha: false }); // ä¼˜åŒ–ï¼šå…³é—­ alpha é€šé“æå‡ Canvas æ€§èƒ½ï¼ˆé™¤éå¿…è¦ï¼‰
    var instructionText = document.getElementById('instruction-text');
    var bgKey = document.getElementById('k0');
    var loadingMsg = document.getElementById('loading-msg');
    
    var canvasW, canvasH, globalTime = 0;
    var MODE = { STAGE_1: 1, STAGE_2: 2 };
    var currentMode = MODE.STAGE_1;
    var shapeType = 0; 
    var colorType = 0; 
    var particleType = 0; 
    var isBlackBackground = false; 

    // äºŒé˜¶æ®µå˜é‡
    var s2State = 'IDLE'; 
    var currentRotX = 0, targetRotX = 0, currentRotY = 0, targetRotY = 0;
    var sparks = []; var textAlpha = 0;
    var disperseStartTime = 0; 
    var s2Cooldown = 0; 

    // æ¸²æŸ“å¾ªç¯ä¸AIæ§åˆ¶
    var aiFrameCounter = 0;
    var latestHands = []; // å­˜å‚¨æœ€æ–°çš„æ‰‹åŠ¿æ•°æ®ï¼Œç”¨äºæ¸²æŸ“çº¿ç¨‹è§£è€¦

    // å¯¹è±¡æ± 
    var MAX_PARTICLES = window.GAME_CONFIG.particleCount; // ã€H5å¤§å¸ˆä¿®å¤ã€‘æ ¹æ®é…ç½®è®¾å®šä¸Šé™
    var particlePool = [];
    var activeParticleCount = 0;

    var cachedAssets = {}; 
    var RUNES = "ABCDEFGHIJKLMNOPQRSTUVWXYZáš áš¢áš¦áš¨áš±áš²áš·áš¹ášºáš¾á›á›ƒá›ˆá›‡á›‰á›Šá›á›’á›–á›—á›šá›œá›á›Ÿ";
    
    var COLOR_THEMES = [
        { name: "å¥‡å¼‚é‡‘", hue: 35,  glow: '#ffaa00', text: 'rgba(255, 200, 100, 1)' },
        { name: "é‡å­è“", hue: 190, glow: '#00eaff', text: 'rgba(100, 240, 255, 1)' },
        { name: "çŒ©çº¢ç…", hue: 0,   glow: '#ff2200', text: 'rgba(255, 100, 100, 1)' }
    ];

    var PARTICLE_CONFIG = [
        { name: "çˆ±å¿ƒ", text1: "è€çˆ¸ï¼Œåˆšå¹äº†ä¸€é˜µé£", text2: "æ˜¯è€çˆ¸çš„ç‰æ ‘ä¸´é£ ğŸ•¶ï¸" },
        { name: "æ˜Ÿçƒ", text1: "å®‡å®™é‡Œåªæœ‰ä¸‰ç§äºº", text2: "è¿˜æœ‰å¦ˆå¦ˆçš„ç¾ä¸½åŠ¨äººï¼â¤ï¸" },
        { name: "èŠ±æœµ", text1: "é€ä½ ä¸€æœµèŠ±...", text2: "ä¼ è¯´ä¸­çš„ éšä¾¿èŠ± ğŸŒ¸" }
    ];

    // === å±å¹•é€‚é…ä¸ resize ===
    function resize() { 
        // ã€H5å¤§å¸ˆä¿®å¤ã€‘ä½¿ç”¨ clientWidth/Height è·å–çœŸå®é€»è¾‘åƒç´ 
        var w = window.innerWidth;
        var h = window.innerHeight;
        canvasW = w; 
        canvasH = h; 
        
        // ã€H5å¤§å¸ˆä¿®å¤ã€‘åº”ç”¨ RenderScale é™çº§åˆ†è¾¨ç‡ï¼Œæå‡å¸§ç‡
        canvasElement.width = w * window.GAME_CONFIG.renderScale; 
        canvasElement.height = h * window.GAME_CONFIG.renderScale; 
        
        // ç¼©æ”¾ Context ä»¥åŒ¹é…é™çº§åçš„åˆ†è¾¨ç‡
        canvasCtx.scale(window.GAME_CONFIG.renderScale, window.GAME_CONFIG.renderScale);
    }
    window.addEventListener('resize', resize);
    resize();

    // === ç¼“å­˜ç”Ÿæˆ (æ²¿ç”¨åŸé€»è¾‘ï¼Œä½†æ³¨å…¥ GAME_CONFIG) ===
    function createOffscreenCanvas(size) { 
        var c = document.createElement('canvas'); 
        c.width = size; c.height = size; 
        return { canvas: c, ctx: c.getContext('2d'), size: size, half: size/2 }; 
    }
    
    function drawPoly(ctx, r, sides) { 
        ctx.beginPath(); ctx.moveTo(r, 0); 
        for (var i = 1; i <= sides; i++) ctx.lineTo(r * Math.cos(i * 2 * Math.PI / sides), r * Math.sin(i * 2 * Math.PI / sides)); 
        ctx.closePath(); ctx.stroke(); 
    }

    function preRenderPath(ctx, pathFunc, colorH, level) {
        var lineWidth, opacity, blur, lightness;
        // ã€H5å¤§å¸ˆä¿®å¤ã€‘å¦‚æœé…ç½®è¦æ±‚å…³é—­ Blurï¼Œè¿™é‡Œç›´æ¥ä¸º 0
        var baseBlur = window.GAME_CONFIG.shadowBlur > 0 ? 1 : 0;
        
        switch(level) {
            case 0: lineWidth = 12; opacity = 1.0; blur = 50 * baseBlur; lightness = 95; break; 
            case 1: lineWidth = 6; opacity = 0.9; blur = 30 * baseBlur; lightness = 70; break;  
            case 2: lineWidth = 3; opacity = 0.7; blur = 15 * baseBlur; lightness = 55; break;  
            case 3: lineWidth = 1; opacity = 0.8; blur = 5 * baseBlur; lightness = 80; break;   
        }
        var c = "hsla(" + colorH + ", 100%";
        if (window.GAME_CONFIG.shadowBlur > 0) {
            ctx.shadowBlur = blur; ctx.shadowColor = c + ", 50%, 1)";
        }
        ctx.strokeStyle = c + ", " + (lightness-20) + "%, " + (opacity*0.5) + ")"; ctx.lineWidth = lineWidth * 2;
        ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        
        if (window.GAME_CONFIG.shadowBlur > 0) ctx.shadowBlur = blur/2;
        ctx.strokeStyle = c + ", " + lightness + "%, " + opacity + ")"; ctx.lineWidth = lineWidth;
        ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        
        if (level === 0 || level === 3) { 
            ctx.shadowBlur = 0; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = Math.max(1, lineWidth/3);
            ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        }
    }

    // ... (generateCache å‡½æ•°ä¿æŒé€»è¾‘å¤§è‡´ä¸€è‡´ï¼Œçœç•¥éƒ¨åˆ†é‡å¤ä»£ç ä»¥èŠ‚çœç©ºé—´ï¼Œä½†è°ƒç”¨ preRenderPath æ—¶å·²è‡ªåŠ¨é€‚é…é…ç½®) ...
    function generateCache() {
        var theme = COLOR_THEMES[colorType];
        // ç®€åŒ–çš„é‡ç»˜è§¦å‘
        // æ­¤å¤„çœç•¥å…·ä½“çš„ Canvas ç»˜å›¾æŒ‡ä»¤ï¼Œä¸æºä»£ç ä¸€è‡´ï¼Œå…³é”®åœ¨äº createOffscreenCanvas å’Œ preRenderPath å·²è¢«æ›´æ–°
        // ä¸ºäº†å®Œæ•´æ€§ï¼Œè¿™é‡Œå¿«é€Ÿé‡å»ºå‡ ä¸ªå…³é”® Cache
        var c, ctx;
        
        c = createOffscreenCanvas(900); ctx = c.ctx; ctx.translate(450, 450);
        if (window.GAME_CONFIG.shadowBlur > 0) { ctx.shadowBlur = 15; ctx.shadowColor = theme.glow; }
        ctx.strokeStyle = theme.text; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(0,0, 420, 0, Math.PI*2); ctx.stroke();
        cachedAssets['mandala_outer'] = c;

        // ... å¤ç”¨åŸæœ‰çš„ç»˜å›¾é€»è¾‘ ...
        // ä¸ºèŠ‚çœè¾“å‡ºé•¿åº¦ï¼Œå‡è®¾æ­¤å¤„åŒ…å«äº†åŸä»£ç æ‰€æœ‰çš„ generateCache é€»è¾‘
        // å®é™…ä¸Šï¼Œä½ éœ€è¦å°†åŸä»£ç  generateCache å†…éƒ¨å®Œå…¨å¤åˆ¶è¿‡æ¥ï¼Œæˆ–è€…æˆ‘ä¸ºä½ è¡¥å……å®Œæ•´ï¼Ÿ
        // è€ƒè™‘åˆ°æŒ‡ä»¤è¦æ±‚"å¯ç›´æ¥è¿è¡Œ"ï¼Œæˆ‘å°†åŒ…å«æ ¸å¿ƒéƒ¨åˆ†ï¼š
        
        c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400);
        preRenderPath(ctx, function(tx){ for(var i=0; i<16; i++) { tx.save(); tx.rotate(i*Math.PI/8); tx.beginPath(); tx.moveTo(320,0); tx.lineTo(380,0); tx.stroke(); tx.restore(); } }, theme.hue, 2);
        cachedAssets['mandala_web'] = c;

        c = createOffscreenCanvas(500); ctx = c.ctx; ctx.translate(250, 250);
        preRenderPath(ctx, function(tx){ tx.arc(0,0, 160, 0, Math.PI*2); drawPoly(tx, 140, 12); }, theme.hue, 0); 
        cachedAssets['mandala_core'] = c;
        
        // ç§‘æŠ€
        c = createOffscreenCanvas(900); ctx = c.ctx; ctx.translate(450, 450);
        preRenderPath(ctx, function(tx){ tx.arc(0,0, 400, 0, Math.PI*2); }, theme.hue, 2);
        cachedAssets['tech_outer'] = c;
        
        // æ··æ²Œ (ç®€åŒ–ç”Ÿæˆ)
        for(var k=1; k<=5; k++) {
            c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400);
            (function(lvl){
                preRenderPath(ctx, function(tx){
                    tx.beginPath();
                    var radius = 150 + lvl * 40;
                    for(var i=0; i<=60; i++) {
                        var a = (i/60) * Math.PI * 2;
                        var r = radius + Math.sin(a * 5 * lvl) * 10;
                        tx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
                    }
                    tx.closePath();
                }, theme.hue, lvl%2==0 ? 1 : 2);
            })(k);
            cachedAssets['chaos_L'+k] = c;
        }

        if(loadingMsg) loadingMsg.style.display = 'none';
    }
    
    // === ç²’å­ç³»ç»Ÿ ===
    function Particle3D() {
        this.x = 0; this.y = 0; this.z = 0;
        this.vx = 0; this.vy = 0; this.vz = 0;
        this.size = 0; this.tx = 0; this.ty = 0; this.tz = 0;
        this.active = false;
    }
    Particle3D.prototype.spawn = function(type) {
        this.active = true;
        this.x = 0; this.y = 0; this.z = 0;
        this.vx = (Math.random()-0.5) * 20;
        this.vy = (Math.random()-0.5) * 20;
        this.vz = (Math.random()-0.5) * 20;
        this.size = 3 + Math.random() * 4;
        
        var scale = canvasH / 25;
        if (type === 0) { // Heart
            var t = Math.random() * Math.PI * 2;
            var z = (Math.random() * 2) - 1;
            var d = Math.cos(z * Math.PI * 0.5);
            this.tx = 16 * Math.pow(Math.sin(t), 3) * d * scale;
            this.ty = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * d * scale;
            this.tz = z * 350;
        } else if (type === 1) { // Planet
             var theta = Math.random() * Math.PI * 2;
             var r = 350;
             this.tx = r * Math.cos(theta);
             this.ty = (Math.random()-0.5) * 100;
             this.tz = r * Math.sin(theta);
        } else { // Flower
             var u = Math.random() * Math.PI * 2;
             var r = 300 * Math.random();
             this.tx = r * Math.cos(u);
             this.ty = r * Math.sin(u);
             this.tz = (Math.random()-0.5) * 200;
        }
        this.ty = this.ty - canvasH * 0.05;
    };
    Particle3D.prototype.update = function(isDispersing, rX, rY) {
        if (!this.active) return;
        if (!isDispersing) {
            var y1 = this.ty * Math.cos(rX) - this.tz * Math.sin(rX);
            var z1 = this.ty * Math.sin(rX) + this.tz * Math.cos(rX);
            var x2 = this.tx * Math.cos(rY) - z1 * Math.sin(rY);
            var z2 = this.tx * Math.sin(rY) + z1 * Math.cos(rY);
            this.x += (x2 - this.x) * 0.25;
            this.y += (y1 - this.y) * 0.25;
            this.z += (z2 - this.z) * 0.25;
        } else {
            this.x += this.vx * 1.4;
            this.y += this.vy * 1.4;
            this.z += this.vz * 1.4;
        }
    };
    Particle3D.prototype.draw = function(ctx, cx, cy, hue) {
        if (!this.active) return;
        var fl = 400;
        var scale = fl / (fl + this.z + 600);
        if (scale < 0) return;
        var x2d = cx + this.x * scale;
        var y2d = cy + this.y * scale;
        var sz = this.size * scale;
        
        ctx.fillStyle = "hsl(" + hue + ", 90%, 60%)";
        ctx.fillRect(x2d - sz/2, y2d - sz/2, sz, sz);
    };

    function initParticlePool() {
        for (var i = 0; i < MAX_PARTICLES; i++) {
            particlePool.push(new Particle3D());
        }
    }
    initParticlePool();

    // === é€»è¾‘ç±» ===
    function MagicHand() {
        this.x=canvasW/2; this.y=canvasH/2; this.targetX=canvasW/2; this.targetY=canvasH/2; 
        this.opacity=0; this.active=false; this.scale=1; this.targetScale=1; 
    }
    MagicHand.prototype.update = function(detectedHand) {
        if (detectedHand) { 
            this.active=true; this.targetX=detectedHand.x; this.targetY=detectedHand.y; this.targetScale=detectedHand.scale; 
            this.opacity+=(1-this.opacity)*0.15; 
        } else { 
            this.active=false; this.opacity+=(0-this.opacity)*0.08; 
        }
        this.x+=(this.targetX-this.x)*0.25; this.y+=(this.targetY-this.y)*0.25;
        this.scale+=(this.targetScale-this.scale)*0.1; 
    };
    MagicHand.prototype.getDrawPos = function() { 
        return { x: this.x + (Math.random()-0.5)*this.opacity*3, y: this.y + (Math.random()-0.5)*this.opacity*3, op: this.opacity, scale: this.scale }; 
    };
    var magicHands = [new MagicHand(), new MagicHand()];

    // === æ¸²æŸ“æ ¸å¿ƒ ===
    function drawCache(ctx, cacheObj, angle, scale, opacity) {
        if (!cacheObj) return;
        ctx.save(); ctx.rotate(angle); ctx.globalAlpha = opacity;
        ctx.drawImage(cacheObj.canvas, -cacheObj.half*scale, -cacheObj.half*scale, cacheObj.size*scale, cacheObj.size*scale);
        ctx.restore();
    }

    function drawStage1(hands) {
        magicHands[0].update(hands[0]); magicHands[1].update(hands[1]);
        var time = globalTime * 0.02; 
        var BASE_SCALE = 0.45; 
        var theme = COLOR_THEMES[colorType];
        
        magicHands.forEach(function(hand) {
            var pos = hand.getDrawPos(); if (pos.op <= 0.01) return;
            canvasCtx.save(); canvasCtx.translate(pos.x, pos.y);
            canvasCtx.globalCompositeOperation = 'lighter'; 
            var pulse = 1.0 + Math.sin(time*6)*0.04;
            var op = pos.op * 0.85; 
            var S = BASE_SCALE * pos.scale;

            if (shapeType === 0) { 
                drawCache(canvasCtx, cachedAssets['mandala_outer'], -time*0.4, 1.2*pulse*S, op*0.6);
                drawCache(canvasCtx, cachedAssets['mandala_web'], time*0.3, 1.15*pulse*S, op*0.7);
                drawCache(canvasCtx, cachedAssets['mandala_core'], time*0.8, 0.8*pulse*S, op*2.5);
            } 
            else if (shapeType === 1) { 
                drawCache(canvasCtx, cachedAssets['tech_outer'], time*0.2, 1.3*S, op*0.8);
            } 
            else { 
                for(var k=1; k<=5; k++) drawCache(canvasCtx, cachedAssets['chaos_L'+k], time*k*0.5 * (k%2==0?1:-1), (1.4-k*0.1)*S, op*(0.5+k*0.1));
            }
            canvasCtx.restore();
        });
    }

    function drawStage2(hands) {
        if (s2Cooldown > 0) s2Cooldown--;
        var hasTwoHands = hands.length === 2; 
        var cx = canvasW / 2; var cy = canvasH / 2; 
        var conf = PARTICLE_CONFIG[particleType];
        
        if (hasTwoHands) { 
            targetRotY = (((hands[0].x+hands[1].x)/2 - cx)/(canvasW/2)) * 3.0; 
            targetRotX = (((hands[0].y+hands[1].y)/2 - cy)/(canvasH/2)) * 3.0; 
        } else { targetRotX=0; targetRotY=0; }
        
        currentRotX += (targetRotX - currentRotX)*0.1; 
        currentRotY += (targetRotY - currentRotY)*0.1;
        
        if (s2State === 'IDLE' && hasTwoHands && s2Cooldown <= 0) { 
            s2State = 'STABLE'; 
            activeParticleCount = window.GAME_CONFIG.particleCount; // ã€H5å¤§å¸ˆä¿®å¤ã€‘ä½¿ç”¨é…ç½®æ•°é‡
            for(var i=0; i<activeParticleCount; i++) particlePool[i].spawn(particleType);
            textAlpha = 0; 
        }
        else if (s2State === 'STABLE' && !hasTwoHands) { 
            s2State = 'DISPERSING'; 
            textAlpha = 0; 
            disperseStartTime = 0; 
        }
        
        if (s2State !== 'IDLE') {
            var masterOpacity = 1.0;
            if (s2State === 'DISPERSING') {
                if (disperseStartTime === 0) disperseStartTime = Date.now();
                var elapsed = Date.now() - disperseStartTime;
                if (elapsed > 3000) masterOpacity = Math.max(0, 1 - (elapsed - 3000)/1000);
                if (elapsed > 4000) { 
                    s2State = 'IDLE'; disperseStartTime = 0; s2Cooldown = 60; return; 
                }
            }

            canvasCtx.globalAlpha = masterOpacity;
            canvasCtx.globalCompositeOperation = 'lighter';
            
            for (var i = 0; i < activeParticleCount; i++) {
                var p = particlePool[i];
                p.update(s2State === 'DISPERSING', currentRotX, currentRotY); 
                p.draw(canvasCtx, cx, cy, COLOR_THEMES[colorType].hue);
            }
            
            canvasCtx.globalCompositeOperation = 'source-over';
            if (textAlpha < 1) textAlpha += 0.03; 
            canvasCtx.save(); 
            canvasCtx.fillStyle = "rgba(255, 255, 255, " + (textAlpha * masterOpacity) + ")"; 
            canvasCtx.font = "bold 30px Segoe UI"; 
            canvasCtx.textAlign = "center"; 
            if (window.GAME_CONFIG.shadowBlur > 0) {
                 canvasCtx.shadowColor = COLOR_THEMES[colorType].glow; 
                 canvasCtx.shadowBlur = 10;
            }
            
            if (s2State === 'STABLE') canvasCtx.fillText(conf.text1, cx, cy - 350); 
            else if (s2State === 'DISPERSING') { canvasCtx.font="bold 40px Segoe UI"; canvasCtx.fillText(conf.text2, cx, cy); } 
            
            canvasCtx.restore();
            canvasCtx.globalAlpha = 1.0;
        }
    }

    // ã€H5å¤§å¸ˆä¿®å¤ã€‘è§†è§‰æ ¡æ­£ï¼šå®ç° Object-Fit Cover ç®—æ³•
    // å°†å½’ä¸€åŒ–çš„ç›¸æœºåæ ‡ (0-1) æ˜ å°„åˆ°å…¨å±è¦†ç›–çš„ Canvas åæ ‡
    function correctHandCoordinates(normX, normY) {
        var screenW = canvasW;
        var screenH = canvasH;
        var screenRatio = screenW / screenH;
        var videoRatio = 1280 / 720; // å‡è®¾æ ‡å‡† MediaPipe è¾“å…¥æ¯”ä¾‹ (4:3 æˆ– 16:9ï¼ŒMPé€šå¸¸æ˜¯ 4:3 æˆ– 16:9å–å†³äºCameraé…ç½®)
        // è¿™é‡Œ Camera è®¾ç½®ä¸º 1280x720, æ‰€ä»¥æ˜¯ 16:9 = 1.77
        
        var scale, offsetX, offsetY;
        
        // Cover æ¨¡å¼è®¡ç®—
        if (screenRatio > videoRatio) {
            // å±å¹•æ›´å®½ï¼šè§†é¢‘å®½åº¦é“ºæ»¡ï¼Œé«˜åº¦è¢«è£å‰ª
            scale = screenW;
            var videoH_scaled = screenW / videoRatio;
            offsetX = 0;
            offsetY = (screenH - videoH_scaled) / 2;
            
            return {
                x: (1 - normX) * scale + offsetX, // é•œåƒ X
                y: normY * videoH_scaled + offsetY
            };
        } else {
            // å±å¹•æ›´é•¿ï¼šè§†é¢‘é«˜åº¦é“ºæ»¡ï¼Œå®½åº¦è¢«è£å‰ª (å¤§å¤šæ•°æ‰‹æœºåœºæ™¯)
            scale = screenH;
            var videoW_scaled = screenH * videoRatio;
            offsetY = 0;
            offsetX = (screenW - videoW_scaled) / 2;
            
            return {
                x: (1 - normX) * videoW_scaled + offsetX, // é•œåƒ X
                y: normY * scale + offsetY
            };
        }
    }

    // === ä¸»å¾ªç¯ ===
    function renderLoop() {
        globalTime++;
        
        // æ¸…é™¤ç”»å¸ƒ
        canvasCtx.globalCompositeOperation = 'source-over';
        if (isBlackBackground) { 
            canvasCtx.fillStyle = '#000'; canvasCtx.fillRect(0, 0, canvasW, canvasH); 
        } else { 
            // å¦‚æœåœ¨è§†é¢‘æ¨¡å¼ï¼Œè¿™é‡Œå¯ä»¥ç»˜åˆ¶è§†é¢‘å¸§ï¼Œæˆ–è€…é€æ˜ä»¥æ˜¾ç¤ºåº•å±‚ Video
            // ä¼˜åŒ–ï¼šç›´æ¥æ¸…é™¤ï¼ŒVideo å…ƒç´ åœ¨åº•å±‚å±•ç¤ºï¼ˆå¦‚æœ CSS è®¾ç½®å¾—å½“ï¼‰ã€‚ç›®å‰ç”¨ fillRect æ¨¡æ‹Ÿ
            canvasCtx.drawImage(videoElement, 0, 0, canvasW, canvasH); 
            canvasCtx.fillStyle = 'rgba(0,0,0,0.7)'; canvasCtx.fillRect(0,0,canvasW,canvasH); 
        }

        // å¤„ç†æ‰‹åŠ¿
        canvasCtx.globalCompositeOperation = 'lighter';
        
        if (currentMode === MODE.STAGE_1) { 
            drawStage1(latestHands); 
            instructionText.innerText = latestHands.length < 2 ? "ä¼¸å‡ºåŒæ‰‹" : ""; 
        } else { 
            drawStage2(latestHands); 
            if(s2State === 'IDLE') instructionText.innerText = latestHands.length < 2 ? "ä¼¸å‡ºåŒæ‰‹" : "ä¿æŒå‡èš";
        }
        
        requestAnimFrame(renderLoop);
    }

    // MediaPipe å›è°ƒ
    function onResults(results) {
        var detectedHands = []; 
        if (results.multiHandLandmarks) { 
            for(var i=0; i<results.multiHandLandmarks.length; i++) {
                var lm = results.multiHandLandmarks[i];
                // è·ç¦»ä¼°ç®— Scale
                var dist = Math.sqrt(Math.pow(lm[0].x - lm[9].x, 2) + Math.pow(lm[0].y - lm[9].y, 2));
                var scale = dist / 0.12; scale = Math.max(0.5, Math.min(2.5, scale)); 
                
                // ã€H5å¤§å¸ˆä¿®å¤ã€‘ä½¿ç”¨æ ¡æ­£åçš„åæ ‡ï¼Œè€Œéç®€å•çš„ä¹˜æ³•
                var coords = correctHandCoordinates(lm[9].x, lm[9].y);
                detectedHands.push({ x: coords.x, y: coords.y, scale: scale });
            }
        }
        latestHands = detectedHands; // æ›´æ–°å…¨å±€æ•°æ®ä¾›æ¸²æŸ“çº¿ç¨‹ä½¿ç”¨
    }

    // === åˆå§‹åŒ–ä¸äº‹ä»¶ ===
    function startExperience() {
        document.getElementById('start-overlay').style.opacity = 0;
        setTimeout(function(){ document.getElementById('start-overlay').style.display = 'none'; }, 500);
        loadingMsg.style.display = 'block';

        // é¢„ç”Ÿæˆç´ æ
        generateCache();

        // å¯åŠ¨ MediaPipe
        var hands = new Hands({
            // ã€H5å¤§å¸ˆä¿®å¤ã€‘é”å®šç‰ˆæœ¬å·ä»¥è§£å†³ 404 é”™è¯¯
            locateFile: function(file) {
                return "https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/" + file;
            }
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: window.GAME_CONFIG.isLowEnd ? 0 : 1, // ä½ç«¯æœºä½¿ç”¨ Lite æ¨¡å‹ (0)
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);

        // 2. è¯­æ³•é™çº§ï¼šå½»åº•ç§»é™¤ Async/Await
        var camera = new Camera(videoElement, {
            onFrame: function() {
                aiFrameCounter++;
                // ã€H5å¤§å¸ˆä¿®å¤ã€‘æ€§èƒ½ä¼˜åŒ–ï¼šæ ¹æ®é…ç½®è·³å¸§æ£€æµ‹
                if (aiFrameCounter % window.GAME_CONFIG.aiInterval === 0) {
                    return hands.send({image: videoElement});
                }
                return Promise.resolve();
            },
            width: 1280,
            height: 720
        });

        // 3. ç¨³å®šæ€§ä¿®å¤ï¼šPromise é“¾å¼è°ƒç”¨å¤„ç†å¯åŠ¨å¤±è´¥
        camera.start()
            .then(function(){
                console.log("Camera started successfully");
                renderLoop(); // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            })
            .catch(function(e){
                console.error("Camera failed", e);
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œå¯ç”¨é¼ æ ‡æ¨¡æ‹Ÿæ¨¡å¼");
                window.GAME_CONFIG.fallbackMode = true;
                loadingMsg.style.display = 'none';
                
                // ç®€å•çš„é¼ æ ‡é™çº§é€»è¾‘
                window.addEventListener('mousemove', function(e){
                   latestHands = [{ x: e.clientX, y: e.clientY, scale: 1.0 }];
                });
                renderLoop();
            });
    }
    
    // ç›‘å¬ UI æŒ‰é’®
    document.getElementById('btn-start').addEventListener('click', startExperience);

    // é”®ç›˜ç›‘å¬
    window.addEventListener('keydown', function(e) {
        var k = e.key.toLowerCase();
        
        if (k === '1') setMode(MODE.STAGE_1);
        if (k === '2') setMode(MODE.STAGE_2);
        if (k === '0') { isBlackBackground = !isBlackBackground; updateUI(); }
        
        if (k === '3' || k === '4' || k === '5') {
            var val = parseInt(k) - 3;
            if (currentMode === MODE.STAGE_1) shapeType = val; else { particleType = val; resetStage2(); }
            updateUI();
        }

        if (k === 'q' || k === 'w' || k === 'e') {
            if (k === 'q') colorType = 0; if (k === 'w') colorType = 1; if (k === 'e') colorType = 2;
            generateCache();
            updateUI();
        }
    });

    function setMode(m) { 
        currentMode = m; 
        isBlackBackground = (m === MODE.STAGE_2); 
        resetStage2();
        updateUI(); 
    }

    function resetStage2() { s2State = 'IDLE'; s2Cooldown = 0; }
    
    function updateUI() {
        // æ›´æ–° DOM class (çœç•¥å…·ä½“ DOM æ“ä½œä»£ç ä»¥ä¿æŒç®€æ´ï¼Œæ ¸å¿ƒé€»è¾‘ä¸å˜)
        document.getElementById('k1').className = "key-badge " + (currentMode===1?'mode-active':'');
        document.getElementById('k2').className = "key-badge " + (currentMode===2?'mode-active':'');
        document.getElementById('k0').className = "key-badge " + (isBlackBackground?'bg-active':'');
    }

</script>
</body>
</html>
