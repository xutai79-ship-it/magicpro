<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K12ç¼–ç¨‹ - å¥‡å¼‚åšå£«ï¼šç»ˆæä¼˜åŒ–ç‰ˆ</title>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        
        /* UI å±‚æ ·å¼ */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 30px; z-index: 10;
        }

        /* å¯åŠ¨é®ç½© (è§£å†³è‡ªåŠ¨æ’­æ”¾ç­–ç•¥) */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer;
        }
        .start-btn {
            border: 2px solid #ffaa00; color: #ffaa00; padding: 15px 40px;
            font-size: 24px; font-weight: bold; border-radius: 50px;
            box-shadow: 0 0 20px #ffaa00; text-transform: uppercase;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #loading {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
            color: #ffaa00; text-align: center; text-shadow: 0 0 20px #ff5500;
            font-size: 18px; font-weight: bold; z-index: 998; opacity: 0; transition: opacity 0.5s;
        }

        /* HUD é¢æ¿æ ·å¼ */
        .hud-panel {
            background: rgba(20, 5, 0, 0.85); 
            border: 2px solid rgba(255, 180, 0, 0.5); border-radius: 40px;
            padding: 15px 40px; backdrop-filter: blur(20px); text-align: center;
            box-shadow: 0 0 80px rgba(255, 120, 0, 0.4); transform: scale(0.9); 
            pointer-events: auto; user-select: none; -webkit-user-select: none;
        }
        .control-group { display: inline-flex; flex-direction: column; align-items: center; margin: 0 10px; }
        .group-label { font-size: 10px; color: #aaa; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .key-badge {
            display: inline-block; width: 30px; height: 30px; line-height: 30px; border-radius: 8px; margin: 0 2px; 
            color: #fff; background: rgba(255,255,255,0.1); font-weight: 900; font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: all 0.2s; position: relative;
        }
        .key-badge:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }
        .mode-active { background: #ffcc00; color: #000; box-shadow: 0 0 20px #ff8800; border-color: #fff; transform: scale(1.1); }
        .sub-active { background: #00eaff; color: #000; box-shadow: 0 0 15px #00eaff; border-color: #fff; }
        .bg-active { background: #ff3333; color: #fff; box-shadow: 0 0 15px #ff0000; border-color: #fff; }
        .status-text { color: #fff; font-size: 18px; margin-top: 12px; display: block; font-weight: 700; text-shadow: 0 0 15px rgba(255,150,0,0.8); }
        .divider { display: inline-block; width: 1px; height: 25px; background: rgba(255,255,255,0.2); margin: 0 5px; vertical-align: middle; }
    </style>
    
    <script>
        // 1. Polyfill: requestAnimationFrame
        window.requestAnimFrame = (function(){
            return window.requestAnimationFrame || window.webkitRequestAnimationFrame || 
                   window.mozRequestAnimationFrame || function(callback){ window.setTimeout(callback, 1000/60); };
        })();
        
        // 2. Polyfill: getUserMedia
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

        // 3. æ€§èƒ½ç”»åƒ (Profiler)
        var ua = navigator.userAgent.toLowerCase();
        var isLowEnd = (ua.indexOf('android') > -1 || window.innerWidth < 800);
        
        // 4. å…¨å±€é…ç½® (Game Config) - é›¶è§†è§‰æŠ˜æŸé…ç½®
        window.GAME_CONFIG = {
            aiInterval: isLowEnd ? 3 : 1, // ä½ç«¯æœºæ¯3å¸§è·‘ä¸€æ¬¡AIï¼Œè§†è§‰ä¸Šé æ’å€¼è¡¥å…¨
            particleCount: 2500,          // ä¿æŒåŸç‰ˆç²’å­æ•°é‡
            shadowBlur: true              // ä¿æŒåŸç‰ˆå…‰æ™•
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="start-overlay">
        <div class="start-btn">ç‚¹å‡»å¼€å¯é­”æ³•</div>
        <div style="color:#aaa; margin-top:20px; font-size:12px">WebAR Engine Ready</div>
    </div>

    <div id="loading">æ­£åœ¨å‡èšé­”åŠ›...</div>
    <video id="input_video" style="display:none" playsinline muted autoplay></video>
    <canvas id="output_canvas"></canvas>
    
    <div id="ui-layer">
        <div class="hud-panel">
            <div style="display:flex; align-items:center; justify-content:center;">
                <div class="control-group">
                    <span class="group-label">Mode</span>
                    <div><span id="k1" class="key-badge mode-active">1</span><span id="k2" class="key-badge">2</span></div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Style</span>
                    <div><span id="k3" class="key-badge sub-active">3</span><span id="k4" class="key-badge">4</span><span id="k5" class="key-badge">5</span></div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Color</span>
                    <div><span id="kq" class="key-badge mode-active">Q</span><span id="kw" class="key-badge">W</span><span id="ke" class="key-badge">E</span></div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">View</span>
                    <div><span id="k0" class="key-badge">CAM</span></div>
                </div>
            </div>
            <span id="instruction-text" class="status-text">ç­‰å¾…æ¿€æ´»</span>
        </div>
    </div>

<script>
    // === HTTPS æ£€æŸ¥ ===
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        alert("å®‰å…¨è­¦å‘Šï¼š\næœ¬åº”ç”¨éœ€è¦è°ƒç”¨æ‘„åƒå¤´ï¼Œå¿…é¡»åœ¨ HTTPS ç¯å¢ƒä¸‹è¿è¡Œã€‚\nè¯·æ£€æŸ¥ç½‘å€æ˜¯å¦ä»¥ https:// å¼€å¤´ã€‚");
    }

    var videoElement = document.getElementById('input_video');
    var canvasElement = document.getElementById('output_canvas');
    var canvasCtx = canvasElement.getContext('2d', { alpha: false }); // ä¼˜åŒ–ï¼šå…³é—­é€æ˜é€šé“
    var loadingDiv = document.getElementById('loading');
    var instructionText = document.getElementById('instruction-text');
    var bgKey = document.getElementById('k0');

    // å…¨å±€çŠ¶æ€
    var canvasW, canvasH, globalTime = 0;
    var MODE = { STAGE_1: 1, STAGE_2: 2 };
    var currentMode = MODE.STAGE_1;
    var shapeType = 0, colorType = 0, particleType = 0;
    var isBlackBackground = false; 
    
    // AI æ•°æ®ç¼“å†² (å®ç°ç®—åŠ›åˆ†ç¦»çš„å…³é”®)
    var latestHandsData = []; // å­˜å‚¨ AI æœ€æ–°ä¸€æ¬¡æ£€æµ‹åˆ°çš„æ•°æ®
    var aiFrameCount = 0;     // AI å¸§è®¡æ•°å™¨

    // äºŒé˜¶æ®µå˜é‡
    var s2State = 'IDLE', s2Cooldown = 0; 
    var currentRotX = 0, targetRotX = 0, currentRotY = 0, targetRotY = 0;
    var sparks = [], textAlpha = 0, disperseStartTime = 0; 

    // å¯¹è±¡æ± 
    var particlePool = [], activeParticleCount = 0;
    var cachedAssets = {}; 
    var RUNES = "ABCDEFGHIJKLMNOPQRSTUVWXYZáš áš¢áš¦áš¨áš±áš²áš·áš¹ášºáš¾á›á›ƒá›ˆá›‡á›‰á›Šá›á›’á›–á›—á›šá›œá›á›Ÿ";
    
    var COLOR_THEMES = [
        { name: "å¥‡å¼‚é‡‘", hue: 35,  glow: '#ffaa00', text: 'rgba(255, 200, 100, 1)' },
        { name: "é‡å­è“", hue: 190, glow: '#00eaff', text: 'rgba(100, 240, 255, 1)' },
        { name: "çŒ©çº¢ç…", hue: 0,   glow: '#ff2200', text: 'rgba(255, 100, 100, 1)' }
    ];

    var PARTICLE_CONFIG = [
        { name: "çˆ±å¿ƒ", text1: "è€çˆ¸ï¼Œåˆšå¹äº†ä¸€é˜µé£ï¼ŒçŒœçŒœä»€ä¹ˆé£ï¼Ÿ", text2: "æ˜¯è€çˆ¸çš„ç‰æ ‘ä¸´é£ ğŸ•¶ï¸" },
        { name: "æ˜Ÿçƒ", text1: "å®‡å®™é‡Œåªæœ‰ä¸‰ç§äººï¼Œç”·äººã€å¥³äººâ€¦â€¦", text2: "è¿˜æœ‰å¦ˆå¦ˆçš„ç¾ä¸½åŠ¨äººï¼â¤ï¸" },
        { name: "èŠ±æœµ", text1: "é€ä½ ä¸€æœµèŠ±...", text2: "ä¼ è¯´ä¸­çš„ éšä¾¿èŠ± ğŸŒ¸" }
    ];

    function resize() { 
        canvasW = window.innerWidth; 
        canvasH = window.innerHeight; 
        canvasElement.width = canvasW; 
        canvasElement.height = canvasH; 
    }
    resize(); 
    window.addEventListener('resize', resize);

    // === è§†è§‰æ ¸å¿ƒ (ä¿ç•™åŸæ±åŸå‘³) ===
    function createOffscreenCanvas(size) { var c = document.createElement('canvas'); c.width = size; c.height = size; return { canvas: c, ctx: c.getContext('2d'), size: size, half: size/2 }; }
    function drawPoly(ctx, r, sides) { ctx.beginPath(); ctx.moveTo(r, 0); for (var i = 1; i <= sides; i++) ctx.lineTo(r * Math.cos(i * 2 * Math.PI / sides), r * Math.sin(i * 2 * Math.PI / sides)); ctx.closePath(); ctx.stroke(); }
    
    function preRenderPath(ctx, pathFunc, colorH, level) {
        var lineWidth, opacity, blur, lightness;
        switch(level) {
            case 0: lineWidth = 12; opacity = 1.0; blur = 50; lightness = 95; break; 
            case 1: lineWidth = 6; opacity = 0.9; blur = 30; lightness = 70; break;  
            case 2: lineWidth = 3; opacity = 0.7; blur = 15; lightness = 55; break;  
            case 3: lineWidth = 1; opacity = 0.8; blur = 5; lightness = 80; break;   
        }
        var c = "hsla(" + colorH + ", 100%";
        ctx.shadowBlur = blur; ctx.shadowColor = c + ", 50%, 1)";
        ctx.strokeStyle = c + ", " + (lightness-20) + "%, " + (opacity*0.5) + ")"; ctx.lineWidth = lineWidth * 2;
        ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        ctx.shadowBlur = blur/2; ctx.strokeStyle = c + ", " + lightness + "%, " + opacity + ")"; ctx.lineWidth = lineWidth;
        ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        if (level === 0 || level === 3) { 
            ctx.shadowBlur = 0; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = Math.max(1, lineWidth/3);
            ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        }
    }

    function generateCache() {
        var theme = COLOR_THEMES[colorType];
        // ä¿æŒåŸç‰ˆç¼“å­˜ç”Ÿæˆé€»è¾‘ï¼Œä¸åšé™çº§
        var c = createOffscreenCanvas(900); var ctx = c.ctx; ctx.translate(450, 450);
        ctx.shadowBlur = 15; ctx.shadowColor = theme.glow; ctx.strokeStyle = theme.text; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(0,0, 420, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(0,0, 380, 0, Math.PI*2); ctx.stroke();
        ctx.fillStyle = theme.text; ctx.font = "bold 24px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        for (var i = 0; i < 64; i++) { ctx.save(); ctx.rotate((i/64)*Math.PI*2); ctx.translate(400, 0); ctx.rotate(Math.PI/2); ctx.fillText(RUNES[i%RUNES.length], 0, 0); ctx.restore(); }
        cachedAssets['mandala_outer'] = c;

        c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400);
        preRenderPath(ctx, function(tx) { for(var i=0; i<16; i++) { tx.save(); tx.rotate(i*Math.PI/8); tx.beginPath(); tx.moveTo(320,0); tx.lineTo(380,0); tx.stroke(); tx.restore(); } }, theme.hue, 2);
        cachedAssets['mandala_web'] = c;

        c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400); preRenderPath(ctx, function(tx) { drawPoly(tx, 330, 32); }, theme.hue, 3); cachedAssets['mandala_fine1'] = c;
        c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400); preRenderPath(ctx, function(tx) { drawPoly(tx, 300, 8); tx.rotate(Math.PI/8); drawPoly(tx, 300, 8); }, theme.hue, 1); cachedAssets['mandala_starA'] = c;
        c = createOffscreenCanvas(700); ctx = c.ctx; ctx.translate(350, 350); preRenderPath(ctx, function(tx) { drawPoly(tx, 260, 6); tx.rotate(Math.PI/6); drawPoly(tx, 260, 6); }, theme.hue, 1); cachedAssets['mandala_hex'] = c;
        c = createOffscreenCanvas(600); ctx = c.ctx; ctx.translate(300, 300); preRenderPath(ctx, function(tx) { tx.arc(0,0, 240, 0, Math.PI*2); for(var i=0; i<8; i++){ tx.save(); tx.rotate(i*Math.PI/4); tx.beginPath(); tx.moveTo(180,0); tx.lineTo(240,0); tx.stroke(); tx.restore(); } }, theme.hue, 3); cachedAssets['mandala_fine2'] = c;
        c = createOffscreenCanvas(600); ctx = c.ctx; ctx.translate(300, 300); preRenderPath(ctx, function(tx) { drawPoly(tx, 220, 4); tx.rotate(Math.PI/4); drawPoly(tx, 220, 4); }, theme.hue, 1); cachedAssets['mandala_square'] = c;
        c = createOffscreenCanvas(500); ctx = c.ctx; ctx.translate(250, 250); preRenderPath(ctx, function(tx) { tx.arc(0,0, 160, 0, Math.PI*2); drawPoly(tx, 140, 12); }, theme.hue, 0); cachedAssets['mandala_core'] = c;

        c = createOffscreenCanvas(300); ctx = c.ctx; ctx.translate(150, 150);
        ctx.fillStyle = '#ffffff'; ctx.font = "bold 18px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.shadowBlur = 20; ctx.shadowColor = '#fff';
        for (var i = 0; i < 24; i++) { ctx.save(); ctx.rotate((i/24)*Math.PI*2); ctx.translate(100, 0); ctx.rotate(Math.PI/2); ctx.fillText(RUNES[i%RUNES.length], 0, 0); ctx.restore(); }
        cachedAssets['mandala_coreRunes'] = c;
        
        c = createOffscreenCanvas(200); ctx = c.ctx; ctx.translate(100, 100);
        ctx.shadowBlur = 60; ctx.shadowColor = '#ffffff'; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 6;
        drawPoly(ctx, 60, 4); ctx.beginPath(); ctx.arc(0,0, 30, 0, Math.PI*2); ctx.stroke();
        cachedAssets['mandala_bright'] = c;

        c = createOffscreenCanvas(900); ctx = c.ctx; ctx.translate(450, 450); preRenderPath(ctx, function(tx) { tx.arc(0,0, 400, 0, Math.PI*2); }, theme.hue, 2); ctx.strokeStyle = theme.text; ctx.lineWidth = 4; for(var i=0; i<60; i++) { ctx.save(); ctx.rotate(i*6*Math.PI/180); ctx.beginPath(); ctx.moveTo(400,0); ctx.lineTo(420,0); ctx.stroke(); ctx.restore(); } cachedAssets['tech_outer'] = c;
        c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400); ctx.fillStyle = "hsla(" + theme.hue + ", 100%, 50%, 0.15)"; for(var i=0; i<4; i++) { ctx.save(); ctx.rotate(i*Math.PI/2); ctx.beginPath(); ctx.arc(0,0, 350, 0, Math.PI/4); ctx.arc(0,0, 250, Math.PI/4, 0, true); ctx.fill(); ctx.restore(); } preRenderPath(ctx, function(tx) { tx.arc(0,0, 350, 0, Math.PI*2); tx.arc(0,0, 250, 0, Math.PI*2); }, theme.hue, 1); cachedAssets['tech_sectors'] = c;
        c = createOffscreenCanvas(600); ctx = c.ctx; ctx.translate(300, 300); preRenderPath(ctx, function(tx) { tx.setLineDash([20,15]); tx.arc(0,0, 200, 0, Math.PI*2); }, theme.hue, 1); cachedAssets['tech_data'] = c;
        c = createOffscreenCanvas(400); ctx = c.ctx; ctx.translate(200, 200); preRenderPath(ctx, function(tx) { tx.arc(0,0, 100, 0, Math.PI*2); tx.moveTo(80,0); tx.lineTo(-80,0); tx.moveTo(0,80); tx.lineTo(0,-80); }, theme.hue, 0); cachedAssets['tech_core'] = c;

        for(var k=1; k<=5; k++) {
            (function(k){
                c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400);
                preRenderPath(ctx, function(tx) {
                    tx.beginPath();
                    var radius = 150 + k * 40; var spikes = 60;
                    for(var i=0; i<=spikes; i++) {
                        var angle = (i/spikes) * Math.PI * 2;
                        var noise = Math.sin(angle * 5 * k) * 10 + Math.sin(angle * 20) * 5 + Math.random()*10;
                        var r = radius + noise; tx.lineTo(Math.cos(angle)*r, Math.sin(angle)*r);
                    }
                    tx.closePath();
                }, theme.hue, k%2==0 ? 1 : 2);
                cachedAssets['chaos_L' + k] = c;
            })(k);
        }
        loadingDiv.style.opacity = 0;
    }

    // === ç²’å­ç±» (Particle3D) ES5 å†™æ³•å…¼å®¹ ===
    function Particle3D() { this.x=0; this.y=0; this.z=0; this.active=false; }
    Particle3D.prototype.spawn = function(type) {
        this.active = true; this.x = 0; this.y = 0; this.z = 0;
        this.vx = (Math.random()-0.5) * 20; this.vy = (Math.random()-0.5) * 20; this.vz = (Math.random()-0.5) * 20;
        this.size = 3 + Math.random() * 4;
        var scale = canvasH / 25;
        if (type === 0) { // Heart
            var t = Math.random() * Math.PI * 2; var z = (Math.random() * 2) - 1; var d = Math.cos(z * Math.PI * 0.5);
            this.tx = 16 * Math.pow(Math.sin(t), 3) * d * scale; this.ty = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * d * scale; this.tz = z * 350;
        } else if (type === 1) { // Planet
            if(Math.random() > 0.3) {
                var theta = Math.random() * Math.PI * 2; var phi = Math.acos(2 * Math.random() - 1); var r = 350;
                this.tx = r * Math.sin(phi) * Math.cos(theta); this.ty = r * Math.sin(phi) * Math.sin(theta); this.tz = r * Math.cos(phi);
            } else {
                var theta = Math.random() * Math.PI * 2; var r = 500 + Math.random() * 80;
                this.tx = r * Math.cos(theta); this.ty = r * Math.sin(theta) * 0.1; this.tz = r * Math.sin(theta);
            }
        } else { // Flower
            var u = Math.random() * Math.PI * 2; var v = Math.random() * Math.PI;
            var rb = 400 * (1 + 0.3 * Math.cos(5 * u)); var r = rb * Math.sin(v);
            this.tx = r * Math.cos(u); this.ty = r * Math.sin(u); this.tz = 150 * Math.cos(v) - (rb/400) * 50;
        }
        this.ty = this.ty - canvasH * 0.05;
    };
    Particle3D.prototype.update = function(isDispersing, rX, rY) {
        if (!this.active) return;
        if (!isDispersing) {
            var y1 = this.ty * Math.cos(rX) - this.tz * Math.sin(rX); var z1 = this.ty * Math.sin(rX) + this.tz * Math.cos(rX);
            var x2 = this.tx * Math.cos(rY) - z1 * Math.sin(rY); var z2 = this.tx * Math.sin(rY) + z1 * Math.cos(rY);
            this.x += (x2 - this.x) * 0.25; this.y += (y1 - this.y) * 0.25; this.z += (z2 - this.z) * 0.25;
        } else {
            this.x += this.vx * 1.4; this.y += this.vy * 1.4; this.z += this.vz * 1.4;
        }
    };
    Particle3D.prototype.draw = function(ctx, cx, cy, hue) {
        if (!this.active) return;
        var fl = 400; var scale = fl / (fl + this.z + 600); if (scale < 0) return;
        var x2d = cx + this.x * scale; var y2d = cy + this.y * scale; var sz = this.size * scale;
        var d = (this.z + 500) / 1200; var l = 80 - d * 40; var a = 1 - d * 0.5;
        ctx.fillStyle = "hsla(" + hue + ", 90%, " + l + "%, " + a + ")";
        ctx.fillRect(x2d - sz/2, y2d - sz/2, sz, sz);
    };

    function initParticlePool() {
        for (var i = 0; i < window.GAME_CONFIG.particleCount; i++) particlePool.push(new Particle3D());
    }
    initParticlePool();

    // === MagicHand ç±» (æ’å€¼çš„æ ¸å¿ƒ) ===
    function MagicHand() { this.x=canvasW/2; this.y=canvasH/2; this.targetX=canvasW/2; this.targetY=canvasH/2; this.opacity=0; this.active=false; this.scale=1; this.targetScale=1; }
    MagicHand.prototype.update = function(detectedHand) {
        // å¦‚æœæœ‰ AI æ•°æ®ï¼Œæ›´æ–°ç›®æ ‡ç‚¹
        if (detectedHand) { 
            this.active = true; 
            this.targetX = detectedHand.x; 
            this.targetY = detectedHand.y; 
            this.targetScale = detectedHand.scale; 
            this.opacity += (1 - this.opacity) * 0.15; 
        } else { 
            // å¦‚æœ AI è¿™ä¸€å¸§æ²¡è·‘ï¼Œæˆ–è€…æ²¡æ£€æµ‹åˆ°æ‰‹ï¼Œopacity é™ä½
            // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰æ¸…ç©º targetXï¼Œæ‰€ä»¥æ‰‹åŠ¿ä¼šå¹³æ»‘åœ°åœç•™åœ¨æœ€åæ¶ˆå¤±çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ç¬ç§»
            this.active = false; 
            this.opacity += (0 - this.opacity) * 0.08; 
        }
        // ç‰©ç†æ’å€¼ (Lerp)ï¼šæ— è®º AI å¤šå°‘å¸§è·‘ä¸€æ¬¡ï¼Œè¿™é‡Œçš„è®¡ç®—æ°¸è¿œæ˜¯ 60FPS
        this.x += (this.targetX - this.x) * 0.25; 
        this.y += (this.targetY - this.y) * 0.25;
        this.scale += (this.targetScale - this.scale) * 0.1; 
    };
    MagicHand.prototype.getDrawPos = function() { 
        return { x: this.x + (Math.random()-0.5)*this.opacity*3, y: this.y + (Math.random()-0.5)*this.opacity*3, op: this.opacity, scale: this.scale }; 
    };
    
    var magicHands = [new MagicHand(), new MagicHand()];

    // === æ‹–å°¾ç²’å­ ===
    function StreakParticle(x, y, hue, angle, speed) {
        this.x=x; this.y=y; this.hue=hue; this.life=1.0;
        this.vx=Math.cos(angle)*speed; this.vy=Math.sin(angle)*speed;
        this.len=30+Math.random()*30; this.width=2+Math.random()*3;
    }
    StreakParticle.prototype.update = function() { this.x+=this.vx; this.y+=this.vy; this.life-=0.05; this.len*=0.96; };
    StreakParticle.prototype.draw = function(ctx) {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(Math.atan2(this.vy, this.vx));
        var g = ctx.createLinearGradient(0,0,this.len,0); g.addColorStop(0, "hsla(" + this.hue + ", 100%, 95%, " + this.life + ")"); g.addColorStop(1, "hsla(" + this.hue + ", 100%, 50%, 0)");
        ctx.fillStyle = g; ctx.fillRect(0, -this.width/2, this.len, this.width); ctx.restore();
    };

    // === ç»˜å›¾è¾…åŠ© ===
    function drawCache(ctx, cacheObj, angle, scale, opacity) {
        if (!cacheObj) return;
        ctx.save(); ctx.rotate(angle); ctx.globalAlpha = opacity;
        ctx.drawImage(cacheObj.canvas, -cacheObj.half*scale, -cacheObj.half*scale, cacheObj.size*scale, cacheObj.size*scale);
        ctx.restore();
    }

    // === Stage 1 ç»˜åˆ¶ ===
    function drawStage1() {
        var time = globalTime * 0.02; 
        var BASE_SCALE = 0.45; 
        var theme = COLOR_THEMES[colorType];
        
        magicHands.forEach(function(hand) {
            var pos = hand.getDrawPos(); if (pos.op <= 0.01) return;
            canvasCtx.save(); canvasCtx.translate(pos.x, pos.y);
            canvasCtx.globalCompositeOperation = 'lighter'; 
            var pulse = 1.0 + Math.sin(time*6)*0.04;
            var op = pos.op * 0.85; 
            var S = BASE_SCALE * pos.scale;

            if (shapeType === 0) { 
                drawCache(canvasCtx, cachedAssets['mandala_outer'], -time*0.4, 1.2*pulse*S, op*0.6);
                drawCache(canvasCtx, cachedAssets['mandala_web'], time*0.3, 1.15*pulse*S, op*0.7);
                drawCache(canvasCtx, cachedAssets['mandala_fine1'], -time*0.2, 1.12*pulse*S, op*0.9);
                drawCache(canvasCtx, cachedAssets['mandala_starA'], -time*0.5, 1.1*pulse*S, op*0.8);
                drawCache(canvasCtx, cachedAssets['mandala_hex'], time*0.6, 1.0*pulse*S, op*0.9);
                drawCache(canvasCtx, cachedAssets['mandala_fine2'], time*0.4, 0.95*pulse*S, op*1.0);
                drawCache(canvasCtx, cachedAssets['mandala_square'], -time*0.7, 0.9*pulse*S, op*1.0);
                drawCache(canvasCtx, cachedAssets['mandala_core'], time*0.8, 0.8*pulse*S, op*2.5);
                drawCache(canvasCtx, cachedAssets['mandala_coreRunes'], -time*1.0, 0.6*pulse*S, op*3.0);
                drawCache(canvasCtx, cachedAssets['mandala_bright'], time*1.5, 0.4*pulse*S, op*4.0);
                drawCache(canvasCtx, cachedAssets['mandala_bright'], time*1.5, 0.4*pulse*S, op*2.0);
                drawCache(canvasCtx, cachedAssets['mandala_bright'], time*1.5, 0.4*pulse*S, op*1.0);
            } else if (shapeType === 1) { 
                drawCache(canvasCtx, cachedAssets['tech_outer'], time*0.2, 1.3*S, op*0.8);
                drawCache(canvasCtx, cachedAssets['tech_sectors'], -time*0.4, 1.1*S, op*0.6);
                drawCache(canvasCtx, cachedAssets['tech_data'], time*0.8, 0.9*S, op*1.0);
                drawCache(canvasCtx, cachedAssets['tech_core'], -time*1.5, 0.5*S, op*2.0);
            } else { 
                for(var k=1; k<=5; k++) drawCache(canvasCtx, cachedAssets['chaos_L'+k], time*k*0.5 * (k%2==0?1:-1), (1.4-k*0.1)*S, op*(0.5+k*0.1));
            }
            canvasCtx.restore();

            if (hand.active) {
                canvasCtx.globalCompositeOperation = 'lighter';
                var r = 400 * S; 
                var count = 40; 
                for(var i=0; i<count; i++) {
                    var angle = Math.random() * Math.PI * 2;
                    var px = pos.x + Math.cos(angle) * r; var py = pos.y + Math.sin(angle) * r;
                    var speed = 20 + Math.random() * 40;
                    var vx = -Math.sin(angle) * speed; var vy = Math.cos(angle) * speed;
                    sparks.push(new StreakParticle(px, py, theme.hue, Math.atan2(vy, vx), speed));
                }
            }
        });
    }

    // === Stage 2 ç»˜åˆ¶ ===
    function drawStage2() {
        if (s2Cooldown > 0) s2Cooldown--;
        var h0 = magicHands[0], h1 = magicHands[1];
        var hasTwoHands = h0.active && h1.active;
        var cx = canvasW / 2; var cy = canvasH / 2; 
        var conf = PARTICLE_CONFIG[particleType];
        
        if (hasTwoHands) { 
            targetRotY = (((h0.x+h1.x)/2 - cx)/(canvasW/2)) * 3.0; 
            targetRotX = (((h0.y+h1.y)/2 - cy)/(canvasH/2)) * 3.0; 
        } else { targetRotX=0; targetRotY=0; }
        
        currentRotX += (targetRotX - currentRotX)*0.1; 
        currentRotY += (targetRotY - currentRotY)*0.1;
        
        if (s2State === 'IDLE' && hasTwoHands && s2Cooldown <= 0) { 
            s2State = 'STABLE'; 
            activeParticleCount = 2500; 
            for(var i=0; i<activeParticleCount; i++) particlePool[i].spawn(particleType);
            textAlpha = 0; 
        } else if (s2State === 'STABLE' && !hasTwoHands) { 
            s2State = 'DISPERSING'; textAlpha = 0; disperseStartTime = 0; 
        }
        
        if (s2State === 'STABLE') instructionText.innerText = "[ç²’å­æ¨¡å¼] ä¿æŒåŒæ‰‹å‡èš | æ¾å¼€åŒæ‰‹é‡Šæ”¾é­”æ³•"; 
        else if (s2State === 'DISPERSING') instructionText.innerText = "é­”æ³•é‡Šæ”¾ï¼";
        
        if (s2State !== 'IDLE') {
            var masterOpacity = 1.0;
            if (s2State === 'DISPERSING') {
                if (disperseStartTime === 0) disperseStartTime = Date.now();
                var elapsed = Date.now() - disperseStartTime;
                if (elapsed > 3000) masterOpacity = Math.max(0, 1 - (elapsed - 3000)/1000);
                if (elapsed > 4000) { s2State = 'IDLE'; disperseStartTime = 0; s2Cooldown = 60; return; }
            }

            canvasCtx.globalAlpha = masterOpacity;
            canvasCtx.globalCompositeOperation = 'lighter';
            
            for (var i = 0; i < activeParticleCount; i++) {
                var p = particlePool[i];
                p.update(s2State === 'DISPERSING', currentRotX, currentRotY); 
                p.draw(canvasCtx, cx, cy, COLOR_THEMES[colorType].hue);
            }
            
            canvasCtx.globalCompositeOperation = 'source-over';
            if (textAlpha < 1) textAlpha += 0.03; 
            canvasCtx.save(); 
            canvasCtx.fillStyle = "rgba(255, 255, 255, " + (textAlpha * masterOpacity) + ")"; 
            canvasCtx.font = "bold 40px Segoe UI"; canvasCtx.textAlign = "center"; 
            canvasCtx.shadowColor = COLOR_THEMES[colorType].glow; canvasCtx.shadowBlur = 20;
            
            if (s2State === 'STABLE') canvasCtx.fillText(conf.text1, cx, cy - 350); 
            else if (s2State === 'DISPERSING') { canvasCtx.font="bold 60px Segoe UI"; canvasCtx.fillText(conf.text2, cx, cy); } 
            
            canvasCtx.restore(); canvasCtx.globalAlpha = 1.0;
        }
    }

    // === ä¸»æ¸²æŸ“å¾ªç¯ (60FPS) ===
    // é€»è¾‘æ¸²æŸ“åˆ†ç¦»ï¼šè¿™é‡Œåªè´Ÿè´£ç”»ç”»ï¼ŒAI é€»è¾‘å•ç‹¬è·‘
    function renderLoop() {
        requestAnimFrame(renderLoop);
        globalTime++; 
        
        // 1. æ¸…ç©º/èƒŒæ™¯
        canvasCtx.globalCompositeOperation = 'source-over';
        if (isBlackBackground) { 
            canvasCtx.fillStyle = '#000'; canvasCtx.fillRect(0, 0, canvasW, canvasH); 
        } else { 
            // ç»˜åˆ¶è§†é¢‘èƒŒæ™¯
            if (videoElement.readyState >= 2) {
                // Cover ç®—æ³•ï¼šç¡®ä¿èƒŒæ™¯ä¸å˜å½¢
                var vW = videoElement.videoWidth, vH = videoElement.videoHeight;
                var scale = Math.max(canvasW / vW, canvasH / vH);
                var x = (canvasW - vW * scale) / 2;
                var y = (canvasH - vH * scale) / 2;
                canvasCtx.drawImage(videoElement, x, y, vW * scale, vH * scale);
            }
            canvasCtx.fillStyle = 'rgba(0,0,0,0.7)'; canvasCtx.fillRect(0,0,canvasW,canvasH); 
        }

        // 2. æ›´æ–°æ‰‹åŠ¿å¹³æ»‘æ’å€¼ (æ ¸å¿ƒï¼šæ— è®º AI æ˜¯å¦æ›´æ–°ï¼Œè¿™é‡Œéƒ½å¹³æ»‘è¿åŠ¨)
        // ä» latestHandsData åŒæ­¥æ•°æ®åˆ° MagicHand
        if (currentMode === MODE.STAGE_1) {
            magicHands[0].update(latestHandsData[0]); 
            magicHands[1].update(latestHandsData[1]);
        } else {
             // Stage 2 å¤ç”¨ MagicHand çš„å¹³æ»‘åæ ‡æ¥è®¡ç®—æ—‹è½¬
             magicHands[0].update(latestHandsData[0]); 
             magicHands[1].update(latestHandsData[1]);
        }

        // 3. ç»˜åˆ¶ç«èŠ±
        canvasCtx.globalCompositeOperation = 'lighter'; 
        for(var i=sparks.length-1; i>=0; i--) {
            sparks[i].update(); sparks[i].draw(canvasCtx);
            if(sparks[i].life <= 0) sparks.splice(i, 1);
        }
        
        // 4. ç»˜åˆ¶ä¸»é˜¶æ®µ
        canvasCtx.globalCompositeOperation = 'source-over';
        if (currentMode === MODE.STAGE_1) { 
            drawStage1(); 
            instructionText.innerText = (!magicHands[0].active && !magicHands[1].active) ? "è¯·ä¼¸å‡ºæ‰‹æŒæ¿€æ´»æ³•é˜µ" : ""; 
        } else { 
            drawStage2(); 
        }
    }

    // === AI å¾ªç¯ (èŠ‚æµæ§åˆ¶) ===
    function runAI() {
        // åªæœ‰è§†é¢‘åœ¨æ’­æ”¾æ—¶æ‰æ£€æµ‹
        if (!videoElement.paused && !videoElement.ended) {
            aiFrameCount++;
            // æ ¹æ®é…ç½®è·³å¸§ï¼šä½ç«¯æœºæ¯ 3 å¸§è·‘ä¸€æ¬¡æ£€æµ‹ï¼Œé«˜ç«¯æœºæ¯å¸§è·‘
            if (aiFrameCount % window.GAME_CONFIG.aiInterval === 0) {
                hands.send({image: videoElement}).then(function(){
                    // æˆåŠŸ
                });
            }
        }
        // è¿™é‡Œçš„ loop ä¾ç„¶è¦å…¨é€Ÿè·‘ï¼Œä½†å®é™… send æ˜¯èŠ‚æµçš„
        requestAnimFrame(runAI);
    }

    // === ç»Ÿä¸€è¾“å…¥å¤„ç† ===
    function handleInput(key) {
        var k = key.toLowerCase();
        if ((k === '1' && currentMode === MODE.STAGE_1) || (k === '2' && currentMode === MODE.STAGE_2)) return;
        if (k === '1') setMode(MODE.STAGE_1);
        if (k === '2') setMode(MODE.STAGE_2);
        if (k === '0') { isBlackBackground = !isBlackBackground; updateBgUI(); }
        if (k === '3') { if (currentMode === MODE.STAGE_1) shapeType = 0; else { particleType = 0; resetStage2(); } updateUI(); }
        if (k === '4') { if (currentMode === MODE.STAGE_1) shapeType = 1; else { particleType = 1; resetStage2(); } updateUI(); }
        if (k === '5') { if (currentMode === MODE.STAGE_1) shapeType = 2; else { particleType = 2; resetStage2(); } updateUI(); }
        if (k === 'q' || k === 'w' || k === 'e') {
            if (k === 'q') colorType = 0; if (k === 'w') colorType = 1; if (k === 'e') colorType = 2;
            loadingDiv.style.opacity = 1; updateUI();
            setTimeout(generateCache, 10);
        }
    }

    // === äº‹ä»¶ç»‘å®š ===
    window.addEventListener('keydown', function(e) { handleInput(e.key); });
    
    // é¼ æ ‡ç‚¹å‡» / è§¦æ‘¸ æ˜ å°„
    var clickMap = { 'k1':'1', 'k2':'2', 'k3':'3', 'k4':'4', 'k5':'5', 'kq':'q', 'kw':'w', 'ke':'e', 'k0':'0' };
    Object.keys(clickMap).forEach(function(id) {
        var el = document.getElementById(id);
        if(el) {
            var handler = function(e) { e.preventDefault(); e.stopPropagation(); handleInput(clickMap[id]); };
            el.addEventListener('click', handler);
            el.addEventListener('touchstart', handler, {passive: false});
        }
    });

    function updateBgUI() { bgKey.className = "key-badge " + (isBlackBackground ? 'bg-active' : ''); }
    function setMode(m) { 
        currentMode = m; 
        if (m === MODE.STAGE_1) isBlackBackground = false; else isBlackBackground = true; 
        resetStage2(); sparks = []; updateUI(); updateBgUI(); 
    }
    function resetStage2() { s2State = 'IDLE'; s2Cooldown = 0; }
    function updateUI() {
        document.getElementById('k1').className = "key-badge " + (currentMode===1?'mode-active':'');
        document.getElementById('k2').className = "key-badge " + (currentMode===2?'mode-active':'');
        var isS1 = currentMode === MODE.STAGE_1;
        document.getElementById('k3').className = "key-badge " + ((isS1 && shapeType===0) || (!isS1 && particleType===0) ? 'sub-active' : '');
        document.getElementById('k4').className = "key-badge " + ((isS1 && shapeType===1) || (!isS1 && particleType===1) ? 'sub-active' : '');
        document.getElementById('k5').className = "key-badge " + ((isS1 && shapeType===2) || (!isS1 && particleType===2) ? 'sub-active' : '');
        document.getElementById('kq').className = "key-badge " + (colorType===0?'mode-active':'');
        document.getElementById('kw').className = "key-badge " + (colorType===1?'mode-active':'');
        document.getElementById('ke').className = "key-badge " + (colorType===2?'mode-active':'');
        bgKey.className = "key-badge " + (isBlackBackground?'bg-active':'');
        var theme = COLOR_THEMES[colorType];
        if (currentMode === MODE.STAGE_1) instructionText.innerText = "æ³•é˜µ: " + ['å¥‡å¼‚æ›¼é™€ç½—','èµ›åšç§‘æŠ€','æ··æ²Œè£‚ç¼'][shapeType] + " | é¢œè‰²: " + theme.name;
        else instructionText.innerText = "å¬å”¤: " + PARTICLE_CONFIG[particleType].name;
    }

    // === MediaPipe åˆå§‹åŒ– (é”å®šç‰ˆæœ¬) ===
    function onResults(results) {
        // é‡è¦ï¼šè¿™é‡Œåªå¤„ç†æ•°æ®ï¼Œä¸ç”»ç”»ï¼
        // Cover ç®—æ³•ï¼šä¿®æ­£åæ ‡æ¼‚ç§»
        var hands = [];
        if (results.multiHandLandmarks) { 
            var vW = videoElement.videoWidth;
            var vH = videoElement.videoHeight;
            // è®¡ç®— cover åçš„ç¼©æ”¾å’Œåç§»
            var scale = Math.max(canvasW / vW, canvasH / vH);
            var xOffset = (canvasW - vW * scale) / 2;
            var yOffset = (canvasH - vH * scale) / 2;

            results.multiHandLandmarks.forEach(function(lm) { 
                var dist = Math.hypot(lm[0].x - lm[9].x, lm[0].y - lm[9].y);
                var s = dist / 0.12; s = Math.max(0.5, Math.min(2.5, s)); 
                
                // åæ ‡è½¬æ¢æ ¸å¿ƒå…¬å¼
                var rawX = lm[9].x * vW * scale + xOffset;
                var rawY = lm[9].y * vH * scale + yOffset;
                
                hands.push({ x: rawX, y: rawY, scale: s }); 
            }); 
        }
        latestHandsData = hands; // æ›´æ–°å…¨å±€æ•°æ®æ± 
    }

    var hands = new Hands({locateFile: function(file) {
        return "https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/" + file;
    }});
    
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5, selfieMode: true });
    hands.onResults(onResults);

    // === å¯åŠ¨é€»è¾‘ (è§£å†³è‡ªåŠ¨æ’­æ”¾é—®é¢˜) ===
    var camera = new Camera(videoElement, {
        onFrame: function() { return Promise.resolve(); }, // è¿™é‡Œçš„ onFrame è¢« runAI æ¥ç®¡äº†ï¼Œç•™ç©ºå³å¯
        width: 1280, height: 720
    });

    // ç»‘å®šå¯åŠ¨æŒ‰é’®
    document.getElementById('start-overlay').addEventListener('click', function() {
        this.style.display = 'none'; // éšè—é®ç½©
        loadingDiv.style.opacity = 1;
        
        // å¿…é¡»ç”¨æˆ·ç‚¹å‡»åæ‰èƒ½è§¦å‘ video.play
        videoElement.play().then(function(){
            return camera.start();
        }).then(function(){
            console.log("Camera started");
            setTimeout(generateCache, 100); // å»¶æ—¶ç”Ÿæˆç¼“å­˜
            renderLoop(); // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            runAI();      // å¯åŠ¨ AI å¾ªç¯
        }).catch(function(e){
            alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + e.message);
        });
    });

</script>
</body>
</html>
