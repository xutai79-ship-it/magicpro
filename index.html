<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K12编程 - 奇异博士：HTTP防弹修复版</title>
    
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        video { display: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* 启动遮罩 */
        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-start {
            margin-top: 20px; padding: 15px 40px; border: 2px solid #ffaa00; color: #ffaa00; background: transparent;
            font-size: 20px; font-weight: bold; border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3); transition: all 0.3s;
        }
        .btn-start:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255, 170, 0, 0.6); }
        
        /* 错误提示条 */
        #env-warning {
            color: #ff5555; font-size: 12px; margin-top: 10px; max-width: 80%; text-align: center; display: none;
            border: 1px solid #ff5555; padding: 5px; border-radius: 5px; background: rgba(50,0,0,0.5);
        }

        /* 调试控制台 */
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(100,0,0,0.8); color: #fff;
            font-size: 10px; padding: 2px; text-align: center; display: none; z-index: 3000; pointer-events: none;
        }

        /* UI 层 */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 30px;
        }
        .hud-panel {
            background: rgba(20, 5, 0, 0.85); border: 2px solid rgba(255, 180, 0, 0.5);
            border-radius: 40px; padding: 10px 20px;
            text-align: center; box-shadow: 0 0 80px rgba(255, 120, 0, 0.4);
            transform: scale(0.9); pointer-events: auto;
        }
        .control-group { display: inline-flex; flex-direction: column; align-items: center; margin: 0 5px; }
        .group-label { font-size: 10px; color: #aaa; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .key-badge {
            display: inline-block; width: 30px; height: 30px; line-height: 30px; border-radius: 8px; margin: 0 2px; 
            color: #fff; background: rgba(255,255,255,0.1); font-weight: 900; font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer;
        }
        .mode-active { background: #ffcc00; color: #000; box-shadow: 0 0 10px #ff8800; border-color: #fff; }
        .sub-active { background: #00eaff; color: #000; box-shadow: 0 0 10px #00eaff; border-color: #fff; }
        .bg-active { background: #ff3333; color: #fff; border-color: #fff; }
        .status-text { color: #fff; font-size: 14px; margin-top: 8px; display: block; font-weight: 700; text-shadow: 0 0 5px rgba(255,150,0,0.8); }
        .divider { display: inline-block; width: 1px; height: 25px; background: rgba(255,255,255,0.2); margin: 0 5px; vertical-align: middle; }
    </style>

    <script id="bootstrap">
        (function() {
            window.onerror = function(msg, url, line) {
                var el = document.getElementById('debug-console');
                if(el) { el.style.display='block'; el.innerHTML = "ERR: " + msg; }
                // 遇到 buffer 错误直接静默处理，避免弹窗吓到用户
                if (msg.indexOf('buffer') !== -1 || msg.indexOf('packed_assets') !== -1) return true; 
            };

            // 环境检测
            var isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            var isHttps = location.protocol === 'https:';
            // 如果不是 HTTPS 且不是本地，标记为不安全，后续将禁用 MediaPipe
            window.IS_SECURE_ENV = isHttps || isLocal;

            // API Shims
            window.requestAnimFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || function(cb){ setTimeout(cb, 1000/30); };
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
            
            // 全局配置
            var isLowEnd = (navigator.hardwareConcurrency || 4) <= 4;
            window.GAME_CONFIG = {
                tier: isLowEnd ? 'LOW' : 'HIGH',
                renderScale: isLowEnd ? 0.7 : 1.0,
                shadowEnabled: !isLowEnd,
                maxParticles: isLowEnd ? 600 : 2500,
                maxCacheSize: isLowEnd ? 512 : 1024
            };
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6.1629159505/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="debug-console"></div>

    <div id="splash-screen">
        <div style="color:#ffaa00; font-size:24px; font-weight:bold; letter-spacing:3px; text-shadow:0 0 20px #ff5500;">
            K12 - MAGIC AR
        </div>
        <div id="env-warning"></div>
        <div style="color:#888; margin-top:10px; font-size:12px;" id="sys-status">系统初始化中...</div>
        <button id="btn-start" class="btn-start" style="display:none">启动系统</button>
    </div>

    <video id="input_video" playsinline webkit-playsinline muted autoplay></video>
    <canvas id="output_canvas"></canvas>

    <div id="ui-layer">
        <div class="hud-panel">
            <div style="display:flex; align-items:center; justify-content:center;">
                <div class="control-group">
                    <span class="group-label">Mode</span>
                    <div>
                        <span id="k1" class="key-badge mode-active">1</span>
                        <span id="k2" class="key-badge">2</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Style</span>
                    <div>
                        <span id="k3" class="key-badge sub-active">3</span>
                        <span id="k4" class="key-badge">4</span>
                        <span id="k5" class="key-badge">5</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Color</span>
                    <div>
                        <span id="kq" class="key-badge mode-active">Q</span>
                        <span id="kw" class="key-badge">W</span>
                        <span id="ke" class="key-badge">E</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">BG</span>
                    <div><span id="k0" class="key-badge">CAM</span></div>
                </div>
            </div>
            <span id="instruction-text" class="status-text">SYSTEM READY</span>
        </div>
    </div>

    <script>
        var videoElement = document.getElementById('input_video');
        var canvasElement = document.getElementById('output_canvas');
        var canvasCtx = canvasElement.getContext('2d', { alpha: false });
        var instructionText = document.getElementById('instruction-text');
        
        var MODE = { STAGE_1: 1, STAGE_2: 2 };
        var state = { mode: MODE.STAGE_1, shape: 0, color: 0, particleType: 0, bgBlack: false, useMouse: false };
        var layout = { scale: 1, ox: 0, oy: 0, vw: 0, vh: 0 };
        var globalTime = 0;
        
        // 对象池与资源
        var particlePool = [];
        var handsResults = [];
        var mousePos = { x: 0.5, y: 0.5, active: false };
        var cachedAssets = {};
        var RUNES = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        var COLOR_THEMES = [
            { name: "奇异金", hue: 35,  glow: '#ffaa00', text: 'rgba(255, 200, 100, 1)' },
            { name: "量子蓝", hue: 190, glow: '#00eaff', text: 'rgba(100, 240, 255, 1)' },
            { name: "猩红煞", hue: 0,   glow: '#ff2200', text: 'rgba(255, 100, 100, 1)' }
        ];
        var PARTICLE_CONFIG = [
            { name: "爱心", text1: "老爸，起风了", text2: "是老爸的玉树临风" },
            { name: "星球", text1: "宇宙浩瀚无垠", text2: "唯你最为闪耀" },
            { name: "花朵", text1: "送你一朵花", text2: "随便花" }
        ];
        var s2Data = { state: 'IDLE', rotX: 0, rotY: 0, tRotX: 0, tRotY: 0, startT: 0, cd: 0, activeCount: 0 };

        // --- 1. 缓存生成系统 (完美保留原效果) ---
        function createOffscreenCanvas(size) {
            var limit = window.GAME_CONFIG.maxCacheSize;
            var finalSize = Math.min(size, limit);
            var scale = finalSize / size;
            var c = document.createElement('canvas'); c.width = finalSize; c.height = finalSize;
            return { canvas: c, ctx: c.getContext('2d'), size: finalSize, half: finalSize/2, contentScale: scale };
        }

        function preRenderPath(ctx, pathFunc, colorH, level) {
            var lw, op, blur, light;
            if (!window.GAME_CONFIG.shadowEnabled) { blur = 0; lw = level === 0 ? 8 : 2; } 
            else { blur = level===0?50:(level===1?30:10); lw = level===0?12:(level===1?6:2); }
            op = 1.0 - level*0.2; light = 95 - level*15;
            var c = "hsla(" + colorH + ", 100%";
            if(window.GAME_CONFIG.shadowEnabled) { ctx.shadowBlur = blur; ctx.shadowColor = c + ", 50%, 1)"; }
            ctx.strokeStyle = c + ", " + (light-20) + "%, " + (op*0.5) + ")"; ctx.lineWidth = lw * 2;
            ctx.beginPath(); pathFunc(ctx); ctx.stroke();
            ctx.shadowBlur = blur/2; ctx.strokeStyle = c + ", " + light + "%, " + op + ")"; ctx.lineWidth = lw;
            ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        }

        function generateCache() {
            var theme = COLOR_THEMES[state.color];
            
            // 曼陀罗外圈
            var o = createOffscreenCanvas(900); var ctx = o.ctx; ctx.scale(o.contentScale, o.contentScale); ctx.translate(450, 450);
            if(window.GAME_CONFIG.shadowEnabled) { ctx.shadowBlur = 15; ctx.shadowColor = theme.glow; }
            ctx.strokeStyle = theme.text; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(0,0, 420, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(0,0, 380, 0, Math.PI*2); ctx.stroke();
            ctx.fillStyle = theme.text; ctx.font = "bold 24px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            var count = window.GAME_CONFIG.tier === 'LOW' ? 20 : 64;
            for (var i = 0; i < count; i++) { ctx.save(); ctx.rotate((i/count)*Math.PI*2); ctx.translate(400, 0); ctx.rotate(Math.PI/2); ctx.fillText(RUNES[i%RUNES.length], 0, 0); ctx.restore(); }
            cachedAssets['mandala_outer'] = o;

            // 科技圈
            o = createOffscreenCanvas(800); ctx = o.ctx; ctx.scale(o.contentScale, o.contentScale); ctx.translate(400, 400);
            preRenderPath(ctx, function(tx) { tx.arc(0,0, 350, 0, Math.PI*2); }, theme.hue, 1);
            ctx.strokeStyle = theme.text; ctx.lineWidth = 4;
            for(var i=0; i<360; i+=10) { ctx.save(); ctx.rotate(i*Math.PI/180); ctx.beginPath(); ctx.moveTo(350,0); ctx.lineTo(370,0); ctx.stroke(); ctx.restore(); }
            cachedAssets['tech_outer'] = o;

            // 混沌线
            for(var k=1; k<=3; k++) {
                o = createOffscreenCanvas(800); ctx = o.ctx; ctx.scale(o.contentScale, o.contentScale); ctx.translate(400, 400);
                preRenderPath(ctx, function(tx) {
                   tx.beginPath(); var rad = 150 + k * 40;
                   for(var j=0; j<=30; j++) { var a = (j/30)*Math.PI*2; var r = rad + Math.random()*20; tx.lineTo(Math.cos(a)*r, Math.sin(a)*r); }
                   tx.closePath();
                }, theme.hue, k);
                cachedAssets['chaos_'+k] = o;
            }
        }

        // --- 2. 粒子类 ---
        function Particle3D() { this.active = false; this.x=0;this.y=0;this.z=0; }
        Particle3D.prototype.spawn = function(type) {
            this.active = true; this.size = 3+Math.random()*4;
            this.vx = (Math.random()-0.5)*20; this.vy = (Math.random()-0.5)*20; this.vz = (Math.random()-0.5)*20;
            this.x=0;this.y=0;this.z=0;
            var scale = 25; // Base scale
            if (type === 0) { // Heart
                var t = Math.random() * Math.PI * 2; var z = (Math.random()*2)-1; var d = Math.cos(z*Math.PI*0.5);
                this.tx = 16 * Math.pow(Math.sin(t), 3) * d * scale;
                this.ty = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * d * scale;
                this.tz = z * 350;
            } else if (type === 1) { // Sphere
                 var theta = Math.random()*Math.PI*2; var phi = Math.acos(2*Math.random()-1); var r = 350;
                 this.tx = r*Math.sin(phi)*Math.cos(theta); this.ty = r*Math.sin(phi)*Math.sin(theta); this.tz = r*Math.cos(phi);
            } else { // Flower
                var u = Math.random()*Math.PI*2; var v = Math.random()*Math.PI; var rb = 400*(1+0.3*Math.cos(5*u)); var r = rb*Math.sin(v);
                this.tx = r*Math.cos(u); this.ty = r*Math.sin(u); this.tz = 150*Math.cos(v)-(rb/400)*50;
            }
            this.ty -= 50;
        };
        Particle3D.prototype.update = function(isDisp, rX, rY) {
            if(!this.active) return;
            if(!isDisp) {
                var y1 = this.ty*Math.cos(rX) - this.tz*Math.sin(rX);
                var z1 = this.ty*Math.sin(rX) + this.tz*Math.cos(rX);
                var x2 = this.tx*Math.cos(rY) - z1*Math.sin(rY);
                var z2 = this.tx*Math.sin(rY) + z1*Math.cos(rY);
                this.x += (x2-this.x)*0.2; this.y += (y1-this.y)*0.2; this.z += (z2-this.z)*0.2;
            } else {
                this.x += this.vx*1.5; this.y += this.vy*1.5; this.z += this.vz*1.5;
            }
        };
        Particle3D.prototype.draw = function(ctx, cx, cy, hue) {
            if(!this.active) return;
            var fl = 400; var scale = fl / (fl + this.z + 600);
            if(scale < 0) return;
            var sz = this.size * scale;
            ctx.fillStyle = "hsla("+hue+", 90%, 60%, 1)";
            ctx.fillRect(cx + this.x*scale - sz/2, cy + this.y*scale - sz/2, sz, sz);
        };
        for(var i=0; i<3000; i++) particlePool.push(new Particle3D());

        // --- 3. 渲染主循环 ---
        function drawCache(ctx, key, x, y, angle, scale, alpha) {
            var asset = cachedAssets[key];
            if(!asset) return;
            ctx.save(); ctx.translate(x, y); ctx.rotate(angle); ctx.globalAlpha = alpha;
            var s = scale / asset.contentScale;
            ctx.drawImage(asset.canvas, -asset.half*s, -asset.half*s, asset.size*s, asset.size*s);
            ctx.restore();
        }

        function renderLoop() {
            globalTime++;
            
            // 背景清理与绘制
            if (state.bgBlack) {
                canvasCtx.fillStyle = '#000'; canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
            } else {
                if (state.useMouse || !videoElement.videoWidth) {
                    canvasCtx.fillStyle = '#111'; canvasCtx.fillRect(0,0,canvasElement.width, canvasElement.height);
                } else {
                    canvasCtx.drawImage(videoElement, layout.ox, layout.oy, layout.vw, layout.vh);
                    canvasCtx.fillStyle = 'rgba(0,0,0,0.6)'; canvasCtx.fillRect(0,0,canvasElement.width, canvasElement.height);
                }
            }

            // 数据源准备 (Mouse vs Camera)
            var targets = [];
            if (state.useMouse) {
                if (mousePos.active) targets.push({x: mousePos.x * canvasElement.width, y: mousePos.y * canvasElement.height, scale: 1.0});
            } else {
                for (var i=0; i<handsResults.length; i++) {
                    var h = handsResults[i];
                    targets.push({x: h.x * layout.vw + layout.ox, y: h.y * layout.vh + layout.oy, scale: h.scale});
                }
            }

            canvasCtx.globalCompositeOperation = 'lighter';
            var theme = COLOR_THEMES[state.color];
            var t = globalTime * 0.02;

            if (state.mode === MODE.STAGE_1) {
                for(var i=0; i<targets.length; i++) {
                    var tg = targets[i]; var s = tg.scale * 0.5;
                    if(state.shape === 0) {
                        drawCache(canvasCtx, 'mandala_outer', tg.x, tg.y, -t*0.5, s*1.2, 0.8);
                        drawCache(canvasCtx, 'chaos_1', tg.x, tg.y, t, s*0.8, 0.7);
                    } else if (state.shape === 1) {
                        drawCache(canvasCtx, 'tech_outer', tg.x, tg.y, t*0.2, s*1.3, 0.8);
                        drawCache(canvasCtx, 'chaos_2', tg.x, tg.y, -t, s*0.6, 1.0);
                    } else {
                        for(var k=1; k<=3; k++) drawCache(canvasCtx, 'chaos_'+k, tg.x, tg.y, t*k, s*(1+k*0.2), 0.6);
                    }
                }
                instructionText.innerText = targets.length === 0 ? (state.useMouse ? "触摸屏幕移动" : "请伸出手") : "SYSTEM ACTIVE";
            } else {
                if(s2Data.cd > 0) s2Data.cd--;
                var hasHands = targets.length >= (state.useMouse ? 1 : 2);
                var cx = canvasElement.width/2; var cy = canvasElement.height/2;

                if(hasHands) {
                    var mx = state.useMouse ? targets[0].x : (targets[0].x+targets[1].x)/2;
                    var my = state.useMouse ? targets[0].y : (targets[0].y+targets[1].y)/2;
                    s2Data.tRotY = (mx - cx)/300; s2Data.tRotX = (my - cy)/300;
                }
                s2Data.rotX += (s2Data.tRotX - s2Data.rotX)*0.1; s2Data.rotY += (s2Data.tRotY - s2Data.rotY)*0.1;

                if (s2Data.state === 'IDLE' && hasHands && s2Data.cd <= 0) {
                    s2Data.state = 'STABLE'; s2Data.activeCount = window.GAME_CONFIG.maxParticles;
                    for(var i=0; i<s2Data.activeCount; i++) particlePool[i].spawn(state.particleType);
                } else if (s2Data.state === 'STABLE' && !hasHands) {
                    s2Data.state = 'DISPERSE'; s2Data.startT = Date.now();
                }

                if (s2Data.state !== 'IDLE') {
                    var isDisp = s2Data.state === 'DISPERSE';
                    var alpha = 1.0;
                    if(isDisp) {
                        var diff = Date.now() - s2Data.startT;
                        if(diff > 3000) alpha = 1 - (diff-3000)/1000;
                        if(diff > 4000) { s2Data.state = 'IDLE'; s2Data.cd = 60; }
                    }
                    canvasCtx.globalAlpha = alpha;
                    for(var i=0; i<s2Data.activeCount; i++) {
                        var p = particlePool[i];
                        p.update(isDisp, s2Data.rotX, s2Data.rotY);
                        p.draw(canvasCtx, cx, cy, theme.hue);
                    }
                    canvasCtx.globalAlpha = 1.0;
                    
                    var txt = PARTICLE_CONFIG[state.particleType];
                    canvasCtx.fillStyle = "rgba(255,255,255," + alpha + ")";
                    canvasCtx.font = "bold 30px sans-serif"; canvasCtx.textAlign = "center";
                    if(s2Data.state === 'STABLE') canvasCtx.fillText(txt.text1, cx, cy-300);
                    else if(isDisp) canvasCtx.fillText(txt.text2, cx, cy);
                }
                instructionText.innerText = s2Data.state === 'IDLE' ? "双手合拢凝聚" : "";
            }

            canvasCtx.globalCompositeOperation = 'source-over';
            window.requestAnimFrame(renderLoop);
        }

        // --- 4. 启动逻辑 (安全检查) ---
        function updateLayout() {
            var cw = window.innerWidth; var ch = window.innerHeight;
            canvasElement.width = cw; canvasElement.height = ch;
            
            if (videoElement.videoWidth && !state.useMouse) {
                var vw = videoElement.videoWidth; var vh = videoElement.videoHeight;
                var screenR = cw / ch; var videoR = vw / vh;
                if (screenR > videoR) {
                    layout.scale = cw / vw; layout.vw = cw; layout.vh = vh * layout.scale;
                    layout.ox = 0; layout.oy = (ch - layout.vh) / 2;
                } else {
                    layout.scale = ch / vh; layout.vh = ch; layout.vw = vw * layout.scale;
                    layout.ox = (cw - layout.vw) / 2; layout.oy = 0;
                }
            } else {
                layout = { scale: 1, ox: 0, oy: 0, vw: cw, vh: ch };
            }
            generateCache();
        }
        window.addEventListener('resize', updateLayout);

        function initApp() {
            var btn = document.getElementById('btn-start');
            var status = document.getElementById('sys-status');
            var warn = document.getElementById('env-warning');
            
            setTimeout(generateCache, 10);
            
            // 安全检查：如果不是 HTTPS 或 localhost
            if (!window.IS_SECURE_ENV) {
                warn.style.display = 'block';
                warn.innerText = "HTTP环境限制：摄像头已禁用，自动切换至触摸模式。";
                status.innerText = "降级模式就绪";
                btn.innerText = "启动触摸体验";
                state.useMouse = true;
                state.bgBlack = true;
                
                btn.style.display = "block";
                btn.onclick = function() {
                    document.getElementById('splash-screen').style.display = 'none';
                    bindMouseEvents();
                    updateLayout();
                    renderLoop();
                };
            } else {
                status.innerText = "等待启动...";
                btn.innerText = "启动魔法";
                btn.style.display = "block";
                
                btn.onclick = function() {
                    btn.style.display = "none";
                    status.innerText = "正在请求摄像头...";
                    startCamera();
                };
            }
        }

        function startCamera() {
            var constraints = { audio: false, video: { facingMode: 'user', width: 1280, height: 720 } };
            
            var p = navigator.mediaDevices ? navigator.mediaDevices.getUserMedia(constraints) : 
                    new Promise(function(resolve, reject) { navigator.getUserMedia(constraints, resolve, reject); });
            
            p.then(function(stream) {
                videoElement.srcObject = stream;
                videoElement.play();
                document.getElementById('sys-status').innerText = "加载 AI 模型...";
                initMediaPipe();
            }).catch(function(err) {
                console.error(err);
                useFallbackMode("摄像头拒绝或不支持: " + err.name);
            });
        }

        function initMediaPipe() {
            try {
                // 锁定 CDN 路径
                var hands = new Hands({locateFile: function(file) {
                    return 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/' + file;
                }});
                
                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 0, // 降低复杂度以提升 HTTP/低端环境稳定性
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                hands.onResults(function(results) {
                    handsResults = [];
                    if (results.multiHandLandmarks) {
                        for (var i = 0; i < results.multiHandLandmarks.length; i++) {
                            var lm = results.multiHandLandmarks[i];
                            var d = Math.abs(lm[0].x - lm[9].x);
                            var s = Math.max(0.5, Math.min(2.5, d/0.12));
                            handsResults.push({ x: lm[9].x, y: lm[9].y, scale: s });
                        }
                    }
                });

                function sendFrame() {
                    if(!videoElement.paused && !videoElement.ended) {
                        hands.send({image: videoElement}).then(function(){});
                    }
                    setTimeout(sendFrame, 40); // 限制帧率
                }
                sendFrame();

                document.getElementById('splash-screen').style.display = 'none';
                updateLayout();
                renderLoop();

            } catch(e) {
                useFallbackMode("MediaPipe 初始化失败");
            }
        }

        function useFallbackMode(reason) {
            document.getElementById('env-warning').style.display = 'block';
            document.getElementById('env-warning').innerText = reason + "，切换至触摸模式。";
            document.getElementById('splash-screen').style.display = 'none';
            state.useMouse = true;
            state.bgBlack = true;
            bindMouseEvents();
            updateLayout();
            renderLoop();
        }

        function bindMouseEvents() {
            window.addEventListener('mousemove', function(e) {
                mousePos.active = true; mousePos.x = e.clientX / window.innerWidth; mousePos.y = e.clientY / window.innerHeight;
            });
            window.addEventListener('touchmove', function(e) {
                e.preventDefault(); mousePos.active = true; mousePos.x = e.touches[0].clientX / window.innerWidth; mousePos.y = e.touches[0].clientY / window.innerHeight;
            }, {passive:false});
            window.addEventListener('touchstart', function(e){ mousePos.active=true; });
        }

        // --- 5. UI 绑定 ---
        function updateUI() {
            function setCls(id, active, type) { document.getElementById(id).className = "key-badge " + (active ? type : ""); }
            setCls('k1', state.mode===1, 'mode-active'); setCls('k2', state.mode===2, 'mode-active');
            var isS1 = state.mode===1;
            setCls('k3', (isS1 && state.shape===0)||(!isS1 && state.particleType===0), 'sub-active');
            setCls('k4', (isS1 && state.shape===1)||(!isS1 && state.particleType===1), 'sub-active');
            setCls('k5', (isS1 && state.shape===2)||(!isS1 && state.particleType===2), 'sub-active');
            setCls('kq', state.color===0, 'mode-active'); setCls('kw', state.color===1, 'mode-active'); setCls('ke', state.color===2, 'mode-active');
            setCls('k0', state.bgBlack, 'bg-active');
            generateCache();
        }
        function bindKey(id, cb) { var el = document.getElementById(id); el.onclick = cb; el.ontouchstart = function(e){e.preventDefault();cb();}; }
        
        bindKey('k1', function(){state.mode=1;state.bgBlack=state.useMouse;updateUI();});
        bindKey('k2', function(){state.mode=2;state.bgBlack=true;s2Data.state='IDLE';updateUI();});
        bindKey('k3', function(){if(state.mode===1)state.shape=0;else{state.particleType=0;s2Data.state='IDLE';}updateUI();});
        bindKey('k4', function(){if(state.mode===1)state.shape=1;else{state.particleType=1;s2Data.state='IDLE';}updateUI();});
        bindKey('k5', function(){if(state.mode===1)state.shape=2;else{state.particleType=2;s2Data.state='IDLE';}updateUI();});
        bindKey('kq', function(){state.color=0;updateUI();}); bindKey('kw', function(){state.color=1;updateUI();}); bindKey('ke', function(){state.color=2;updateUI();});
        bindKey('k0', function(){state.bgBlack=!state.bgBlack;updateUI();});

        initApp();
    </script>
</body>
</html>
