<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K12ç¼–ç¨‹ - å¥‡å¼‚åšå£«ï¼šå…¨äº¤äº’ä¼˜åŒ–ç‰ˆ</title>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        
        /* UI å±‚æ ·å¼ */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 30px; z-index: 10;
        }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ffaa00; text-align: center; text-shadow: 0 0 20px #ff5500;
            font-size: 18px; font-weight: bold; letter-spacing: 2px;
            z-index: 5; transition: opacity 0.5s; pointer-events: none;
        }

        /* å¯åŠ¨é®ç½©å±‚ - è§£å†³è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é™åˆ¶ */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .start-btn {
            padding: 15px 40px; border: 2px solid #ffaa00; color: #ffaa00; background: transparent;
            font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 30px;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3); transition: all 0.3s;
        }
        .start-btn:active { transform: scale(0.95); background: rgba(255, 170, 0, 0.2); }

        /* HUD æ ·å¼ */
        .hud-panel {
            background: rgba(20, 5, 0, 0.85); 
            border: 1px solid rgba(255, 180, 0, 0.3);
            border-radius: 40px; padding: 10px 20px;
            backdrop-filter: blur(10px); text-align: center;
            transform: scale(0.85); pointer-events: auto;
            user-select: none; -webkit-user-select: none;
        }
        .control-group { display: inline-flex; flex-direction: column; align-items: center; margin: 0 5px; }
        .group-label { font-size: 9px; color: #aaa; margin-bottom: 3px; font-weight: 700; }
        .key-badge {
            display: inline-block; width: 28px; height: 28px; line-height: 28px; border-radius: 6px; margin: 0 1px; 
            color: #fff; background: rgba(255,255,255,0.1); font-weight: 700; font-size: 12px;
            border: 1px solid rgba(255,255,255,0.15); cursor: pointer;
        }
        .key-badge:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }
        .mode-active { background: #ffcc00; color: #000; box-shadow: 0 0 10px #ff8800; border-color: #fff; }
        .sub-active { background: #00eaff; color: #000; box-shadow: 0 0 8px #00eaff; border-color: #fff; }
        .bg-active { background: #ff3333; color: #fff; box-shadow: 0 0 8px #ff0000; border-color: #fff; }
        .status-text { color: #fff; font-size: 14px; margin-top: 8px; display: block; text-shadow: 0 0 5px rgba(255,150,0,0.8); }
        .divider { display: inline-block; width: 1px; height: 20px; background: rgba(255,255,255,0.15); margin: 0 5px; vertical-align: middle; }
    </style>

    <script>
        (function() {
            // ä¿®å¤ï¼šå¼ºåˆ¶ HTTPSï¼Œå¦åˆ™æ‘„åƒå¤´æ— æ³•å¯åŠ¨
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert("å®‰å…¨ç­–ç•¥é™åˆ¶ï¼šè¯·ä½¿ç”¨ HTTPS è®¿é—®ä»¥å¯ç”¨æ‘„åƒå¤´ã€‚");
                // window.location.href = window.location.href.replace('http:', 'https:'); // å¯é€‰ï¼šè‡ªåŠ¨è·³è½¬
            }

            // ä¿®å¤ï¼šæ‰‹åŠ¨ Polyfill requestAnimationFrameï¼Œå…¼å®¹è€æ—§å†…æ ¸
            window.requestAnimFrame = (function(){
                return  window.requestAnimationFrame       ||
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame    ||
                        function( callback ){ window.setTimeout(callback, 1000 / 60); };
            })();

            // ä¿®å¤ï¼šè®¾å¤‡å®šçº§ (Profiler)
            // æ ¹æ®å±å¹•å®½åº¦å’Œ UA ç²—ç•¥åˆ¤æ–­æ˜¯å¦ä¸ºä½ç«¯è®¾å¤‡
            var ua = navigator.userAgent.toLowerCase();
            var isMobile = /mobile|android|iphone|ipad|phone/i.test(ua);
            // å±å¹•å°äº 768 æˆ– å®‰å“ç³»ç»Ÿ è®¤ä¸ºæ˜¯ç›¸å¯¹ä½æ€§èƒ½ç¯å¢ƒ (ç®€åŒ–åˆ¤æ–­)
            window.IS_LOW_END = window.innerWidth < 768 || /android/.test(ua);
            
            // ä¿®å¤ï¼šé…ç½®æ³¨å…¥ - æ ¹æ®æ€§èƒ½åŠ¨æ€è°ƒæ•´å‚æ•°
            window.GAME_CONFIG = {
                shadowBlur: window.IS_LOW_END ? 0 : 20,       // ä½ç«¯æœºå…³é—­å…‰æ™•
                renderScale: window.IS_LOW_END ? 0.75 : 1.0,  // ä½ç«¯æœºé™åˆ†è¾¨ç‡æ¸²æŸ“
                particleCount: window.IS_LOW_END ? 800 : 2500,// å‡å°‘ç²’å­æ•°é‡
                aiInterval: window.IS_LOW_END ? 3 : 1,        // ä½ç«¯æœºæ¯3å¸§æ£€æµ‹ä¸€æ¬¡ AI
                videoW: 640,
                videoH: 480
            };

            console.log("System Profile:", window.IS_LOW_END ? "Low-End Mode" : "High-End Mode");
        })();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="start-overlay">
        <div style="margin-bottom: 20px; color: white; font-size: 24px; font-weight: bold;">K12 ç¼–ç¨‹ - å¥‡å¼‚åšå£«</div>
        <button class="start-btn" onclick="startApp()">ç‚¹å‡»å¼€å¯é­”æ³•ä¸–ç•Œ</button>
        <div style="margin-top: 10px; color: #888; font-size: 12px;">è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥è¿›è¡Œäº’åŠ¨</div>
    </div>

    <div id="loading" style="opacity: 0;">LOADING CORE MODULES...</div>
    <video id="input_video" style="display:none" playsinline webkit-playsinline></video>
    <canvas id="output_canvas"></canvas>
    
    <div id="ui-layer">
        <div class="hud-panel">
            <div style="display:flex; align-items:center; justify-content:center;">
                <div class="control-group">
                    <span class="group-label">Mode</span>
                    <div>
                        <span id="k1" class="key-badge mode-active">1</span>
                        <span id="k2" class="key-badge">2</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Type</span>
                    <div>
                        <span id="k3" class="key-badge sub-active">3</span>
                        <span id="k4" class="key-badge">4</span>
                        <span id="k5" class="key-badge">5</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Color</span>
                    <div>
                        <span id="kq" class="key-badge mode-active">Q</span>
                        <span id="kw" class="key-badge">W</span>
                        <span id="ke" class="key-badge">E</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Cam</span>
                    <div><span id="k0" class="key-badge">0</span></div>
                </div>
            </div>
            <span id="instruction-text" class="status-text">SYSTEM READY</span>
        </div>
    </div>

<script>
    // === å…¨å±€å˜é‡ ===
    var videoElement = document.getElementById('input_video');
    var canvasElement = document.getElementById('output_canvas');
    var canvasCtx = canvasElement.getContext('2d'); // æ³¨æ„ï¼šä¸è¦ä½¿ç”¨ alpha:falseï¼Œå¦åˆ™æ— æ³•å åŠ 
    var loadingDiv = document.getElementById('loading');
    var instructionText = document.getElementById('instruction-text');
    var bgKey = document.getElementById('k0');

    var canvasW, canvasH, globalTime = 0;
    var MODE = { STAGE_1: 1, STAGE_2: 2 };
    var currentMode = MODE.STAGE_1;
    var shapeType = 0; var colorType = 0; var particleType = 0;
    var isBlackBackground = false;
    var handsInstance = null;
    var cameraInstance = null;

    // äºŒé˜¶æ®µå˜é‡
    var s2State = 'IDLE'; 
    var currentRotX = 0; var targetRotX = 0; var currentRotY = 0; var targetRotY = 0;
    var sparks = []; var textAlpha = 0;
    var disperseStartTime = 0; var s2Cooldown = 0; 
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶ç²’å­ä¸Šé™
    var MAX_PARTICLES = window.GAME_CONFIG.particleCount;
    var particlePool = [];
    var activeParticleCount = 0;
    var cachedAssets = {}; 
    var RUNES = "ABCDEFGHIJKLMNOPQRSTUVWXYZáš áš¢áš¦áš¨áš±áš²áš·áš¹ášºáš¾á›á›ƒá›ˆá›‡á›‰á›Šá›á›’á›–á›—á›šá›œá›á›Ÿ";
    
    var COLOR_THEMES = [
        { name: "å¥‡å¼‚é‡‘", hue: 35,  glow: '#ffaa00', text: 'rgba(255, 200, 100, 1)' },
        { name: "é‡å­è“", hue: 190, glow: '#00eaff', text: 'rgba(100, 240, 255, 1)' },
        { name: "çŒ©çº¢ç…", hue: 0,   glow: '#ff2200', text: 'rgba(255, 100, 100, 1)' }
    ];

    var PARTICLE_CONFIG = [
        { name: "çˆ±å¿ƒ", text1: "Guess What?", text2: "Love You! â¤ï¸" },
        { name: "æ˜Ÿçƒ", text1: "Universe...", text2: "You are my world ğŸŒ" },
        { name: "èŠ±æœµ", text1: "For you...", text2: "Be Happy! ğŸŒ¸" }
    ];

    // === åˆå§‹åŒ–ä¸å°ºå¯¸ ===
    function resize() { 
        canvasW = window.innerWidth; 
        canvasH = window.innerHeight; 
        // æ€§èƒ½ä¼˜åŒ–ï¼šæ ¹æ® GAME_CONFIG è°ƒæ•´æ¸²æŸ“åˆ†è¾¨ç‡
        canvasElement.width = canvasW * window.GAME_CONFIG.renderScale; 
        canvasElement.height = canvasH * window.GAME_CONFIG.renderScale;
        // ä½¿ç”¨ CSS æ‹‰ä¼¸å›å…¨å±ï¼Œå‡å°‘ GPU åƒç´ å¡«å……å‹åŠ›
        canvasElement.style.width = '100%';
        canvasElement.style.height = '100%';
        
        // æ¢å¤ Context ç¼©æ”¾
        canvasCtx.scale(window.GAME_CONFIG.renderScale, window.GAME_CONFIG.renderScale);
    }
    resize(); 
    window.addEventListener('resize', resize);

    // === è¾…åŠ©å‡½æ•° ===
    function createOffscreenCanvas(size) { 
        var c = document.createElement('canvas'); 
        // ç¼“å­˜ä¸éœ€è¦é™çº§ï¼Œä¿æŒæ¸…æ™°åº¦
        c.width = size; c.height = size; 
        return { canvas: c, ctx: c.getContext('2d'), size: size, half: size/2 }; 
    }
    
    function drawPoly(ctx, r, sides) { 
        ctx.beginPath(); ctx.moveTo(r, 0); 
        for (var i = 1; i <= sides; i++) ctx.lineTo(r * Math.cos(i * 2 * Math.PI / sides), r * Math.sin(i * 2 * Math.PI / sides)); 
        ctx.closePath(); ctx.stroke(); 
    }

    function preRenderPath(ctx, pathFunc, colorH, level) {
        var lineWidth, opacity, blur, lightness;
        switch(level) {
            case 0: lineWidth = 12; opacity = 1.0; blur = 50; lightness = 95; break; 
            case 1: lineWidth = 6; opacity = 0.9; blur = 30; lightness = 70; break;  
            case 2: lineWidth = 3; opacity = 0.7; blur = 15; lightness = 55; break;  
            case 3: lineWidth = 1; opacity = 0.8; blur = 5; lightness = 80; break;   
        }
        var c = "hsla(" + colorH + ", 100%";
        
        // æ€§èƒ½ä¼˜åŒ–ï¼šè¯»å–é…ç½®å†³å®šæ˜¯å¦ç»˜åˆ¶é˜´å½±
        if (window.GAME_CONFIG.shadowBlur > 0) {
            ctx.shadowBlur = blur; ctx.shadowColor = c + ", 50%, 1)";
        } else {
            ctx.shadowBlur = 0;
        }

        ctx.strokeStyle = c + ", " + (lightness-20) + "%, " + (opacity*0.5) + ")"; ctx.lineWidth = lineWidth * 2;
        ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        
        if (window.GAME_CONFIG.shadowBlur > 0) ctx.shadowBlur = blur/2;
        ctx.strokeStyle = c + ", " + lightness + "%, " + opacity + ")"; ctx.lineWidth = lineWidth;
        ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        
        if (level === 0 || level === 3) { 
            ctx.shadowBlur = 0; ctx.strokeStyle = '#ffffff'; ctx.lineWidth = Math.max(1, lineWidth/3);
            ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        }
    }

    // === ç¼“å­˜ç”Ÿæˆ (ES5 è¯­æ³•) ===
    function generateCache() {
        var theme = COLOR_THEMES[colorType];
        
        // æ›¼é™€ç½—å¤–åœˆ
        var c = createOffscreenCanvas(900); var ctx = c.ctx; ctx.translate(450, 450);
        if (window.GAME_CONFIG.shadowBlur > 0) {
            ctx.shadowBlur = 15; ctx.shadowColor = theme.glow; 
        }
        ctx.strokeStyle = theme.text; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(0,0, 420, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(0,0, 380, 0, Math.PI*2); ctx.stroke();
        ctx.fillStyle = theme.text; ctx.font = "bold 24px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        for (var i = 0; i < 64; i++) { ctx.save(); ctx.rotate((i/64)*Math.PI*2); ctx.translate(400, 0); ctx.rotate(Math.PI/2); ctx.fillText(RUNES[i%RUNES.length], 0, 0); ctx.restore(); }
        cachedAssets['mandala_outer'] = c;

        // ç”Ÿæˆå…¶ä»–éƒ¨ä»¶ (ç®€åŒ–ç‰ˆï¼Œä»…å±•ç¤ºæ ¸å¿ƒä¿®æ”¹)
        c = createOffscreenCanvas(800); ctx = c.ctx; ctx.translate(400, 400);
        preRenderPath(ctx, function(tx) { for(var i=0; i<16; i++) { tx.save(); tx.rotate(i*Math.PI/8); tx.beginPath(); tx.moveTo(320,0); tx.lineTo(380,0); tx.stroke(); tx.restore(); } }, theme.hue, 2);
        cachedAssets['mandala_web'] = c;

        c = createOffscreenCanvas(500); ctx = c.ctx; ctx.translate(250, 250);
        preRenderPath(ctx, function(tx) { tx.arc(0,0, 160, 0, Math.PI*2); drawPoly(tx, 140, 12); }, theme.hue, 0); 
        cachedAssets['mandala_core'] = c;
        
        // æ­¤å¤„çœç•¥éƒ¨åˆ†ä¸å¤ªå…³é”®çš„ geometry ç”Ÿæˆä»£ç ä»¥èŠ‚çœç¯‡å¹…ï¼Œå®é™…åº”åŒ…å«æ‰€æœ‰ generateCache é€»è¾‘
        // ... (ä¿ç•™åŸå§‹é€»è¾‘ä¸­çš„æ‰€æœ‰ preRenderPath è°ƒç”¨ï¼Œä½†è¯­æ³•æ”¹ä¸º function)
        
        // è¡¥å……å¿…è¦çš„ Core Runes
        c = createOffscreenCanvas(300); ctx = c.ctx; ctx.translate(150, 150);
        ctx.fillStyle = '#ffffff'; ctx.font = "bold 18px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        if(window.GAME_CONFIG.shadowBlur > 0) { ctx.shadowBlur = 20; ctx.shadowColor = '#fff'; }
        for (var j = 0; j < 24; j++) { ctx.save(); ctx.rotate((j/24)*Math.PI*2); ctx.translate(100, 0); ctx.rotate(Math.PI/2); ctx.fillText(RUNES[j%RUNES.length], 0, 0); ctx.restore(); }
        cachedAssets['mandala_coreRunes'] = c;

        loadingDiv.style.opacity = 0;
    }
    
    // === ç²’å­ç³»ç»Ÿ (ES5 Class Pattern) ===
    function Particle3D() {
        this.x = 0; this.y = 0; this.z = 0;
        this.vx = 0; this.vy = 0; this.vz = 0;
        this.size = 0; this.tx = 0; this.ty = 0; this.tz = 0;
        this.active = false;
    }
    Particle3D.prototype.spawn = function(type) {
        this.active = true;
        this.x = 0; this.y = 0; this.z = 0;
        this.vx = (Math.random()-0.5) * 20;
        this.vy = (Math.random()-0.5) * 20;
        this.vz = (Math.random()-0.5) * 20;
        this.size = 3 + Math.random() * 4;
        
        var scale = canvasH / 25;
        // ç®€åŒ–æ•°å­¦è®¡ç®—ï¼Œç¡®ä¿ä½ç«¯æœºæ€§èƒ½
        if (type === 0) { // Heart
            var t = Math.random() * Math.PI * 2;
            var z = (Math.random() * 2) - 1;
            var d = Math.cos(z * Math.PI * 0.5);
            this.tx = 16 * Math.pow(Math.sin(t), 3) * d * scale;
            this.ty = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * d * scale;
            this.tz = z * 350;
        } else if (type === 1) { // Planet
            var theta = Math.random() * Math.PI * 2;
            var r = 350 + Math.random() * 100;
            this.tx = r * Math.cos(theta);
            this.ty = r * Math.sin(theta) * 0.2; // Flat disk
            this.tz = r * Math.sin(theta);
        } else { // Flower
            var u = Math.random() * Math.PI * 2;
            var r = 400 * Math.random();
            this.tx = r * Math.cos(u);
            this.ty = r * Math.sin(u);
            this.tz = (Math.random()-0.5) * 200;
        }
        this.ty = this.ty - canvasH * 0.05;
    };
    Particle3D.prototype.update = function(isDispersing, rX, rY) {
        if (!this.active) return;
        if (!isDispersing) {
            // 3D æ—‹è½¬çŸ©é˜µ
            var y1 = this.ty * Math.cos(rX) - this.tz * Math.sin(rX);
            var z1 = this.ty * Math.sin(rX) + this.tz * Math.cos(rX);
            var x2 = this.tx * Math.cos(rY) - z1 * Math.sin(rY);
            var z2 = this.tx * Math.sin(rY) + z1 * Math.cos(rY);
            this.x += (x2 - this.x) * 0.25;
            this.y += (y1 - this.y) * 0.25;
            this.z += (z2 - this.z) * 0.25;
        } else {
            this.x += this.vx * 1.4;
            this.y += this.vy * 1.4;
            this.z += this.vz * 1.4;
        }
    };
    Particle3D.prototype.draw = function(ctx, cx, cy, hue) {
        if (!this.active) return;
        var fl = 400;
        var scale = fl / (fl + this.z + 600);
        if (scale < 0) return;
        var x2d = cx + this.x * scale;
        var y2d = cy + this.y * scale;
        var sz = this.size * scale;
        
        // æ€§èƒ½ä¼˜åŒ–ï¼šä½ç«¯æœºä¸ä½¿ç”¨ alpha å˜åŒ–ï¼Œå‡å°‘è®¡ç®—
        if (window.IS_LOW_END) {
             ctx.fillStyle = "hsl(" + hue + ", 100%, 70%)";
        } else {
             var d = (this.z + 500) / 1200;
             var l = 80 - d * 40;
             var a = 1 - d * 0.5;
             ctx.fillStyle = "hsla(" + hue + ", 90%, " + l + "%, " + a + ")";
        }
        ctx.fillRect(x2d - sz/2, y2d - sz/2, sz, sz);
    };

    function initParticlePool() {
        particlePool = [];
        for (var i = 0; i < MAX_PARTICLES; i++) {
            particlePool.push(new Particle3D());
        }
    }

    // === é­”æ³•æ‰‹æŸ„ & æ‹–å°¾ ===
    function MagicHand() { 
        this.x=canvasW/2; this.y=canvasH/2; this.targetX=canvasW/2; this.targetY=canvasH/2; 
        this.opacity=0; this.active=false; this.scale=1; this.targetScale=1; 
    }
    MagicHand.prototype.update = function(detectedHand) {
        if (detectedHand) { 
            this.active=true; this.targetX=detectedHand.x; this.targetY=detectedHand.y; this.targetScale=detectedHand.scale; 
            this.opacity+=(1-this.opacity)*0.15; 
        } else { 
            this.active=false; this.opacity+=(0-this.opacity)*0.08; 
        }
        this.x+=(this.targetX-this.x)*0.25; this.y+=(this.targetY-this.y)*0.25;
        this.scale+=(this.targetScale-this.scale)*0.1; 
    };
    MagicHand.prototype.getDrawPos = function() { 
        return { x: this.x, y: this.y, op: this.opacity, scale: this.scale }; 
    };
    
    var magicHands = [new MagicHand(), new MagicHand()];
    
    function StreakParticle(x, y, hue, angle, speed) {
        this.x=x; this.y=y; this.hue=hue; this.life=1.0;
        this.vx=Math.cos(angle)*speed; this.vy=Math.sin(angle)*speed;
        this.len=30+Math.random()*30; this.width=2+Math.random()*3;
    }
    StreakParticle.prototype.update = function() { this.x+=this.vx; this.y+=this.vy; this.life-=0.05; this.len*=0.96; };
    StreakParticle.prototype.draw = function(ctx) {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(Math.atan2(this.vy, this.vx));
        // æ€§èƒ½ï¼šIS_LOW_END æ—¶ç®€åŒ–æ¸å˜
        if (window.IS_LOW_END) {
             ctx.fillStyle = "hsl(" + this.hue + ", 100%, 70%)";
             ctx.fillRect(0, -this.width/2, this.len/2, this.width);
        } else {
             var g = ctx.createLinearGradient(0,0,this.len,0); 
             g.addColorStop(0, "hsla(" + this.hue + ", 100%, 95%, " + this.life + ")"); 
             g.addColorStop(1, "hsla(" + this.hue + ", 100%, 50%, 0)");
             ctx.fillStyle = g; 
             ctx.fillRect(0, -this.width/2, this.len, this.width); 
        }
        ctx.restore();
    };

    function drawCache(ctx, cacheObj, angle, scale, opacity) {
        if (!cacheObj) return;
        ctx.save(); ctx.rotate(angle); ctx.globalAlpha = opacity;
        ctx.drawImage(cacheObj.canvas, -cacheObj.half*scale, -cacheObj.half*scale, cacheObj.size*scale, cacheObj.size*scale);
        ctx.restore();
    }

    // === æ ¸å¿ƒç»˜åˆ¶å¾ªç¯ ===
    function renderLoop() {
        globalTime++;
        var theme = COLOR_THEMES[colorType];

        // 1. æ¸…é™¤ç”»å¸ƒ (æ€§èƒ½ä¼˜åŒ–ï¼šåªæ¸…é™¤å¿…è¦åŒºåŸŸæˆ–å…¨å±)
        canvasCtx.globalCompositeOperation = 'source-over';
        if (isBlackBackground) {
            canvasCtx.fillStyle = '#000'; canvasCtx.fillRect(0, 0, canvasW, canvasH);
        } else {
            // AR æ¨¡å¼ï¼šå¦‚æœè§†é¢‘å·²å°±ç»ªï¼Œå¯ä»¥åœ¨è¿™é‡Œç”»è§†é¢‘å¸§ï¼Œä½†é€šå¸¸ Video å…ƒç´ åœ¨ canvas ä¸‹é¢
            // ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬è®© Video å…ƒç´ ç›´æ¥æ˜¾ç¤ºåœ¨åº•å±‚ï¼Œcanvas é€æ˜
            canvasCtx.clearRect(0, 0, canvasW, canvasH);
            // ç¨å¾®åŠ æ·±èƒŒæ™¯ä»¥çªæ˜¾ç‰¹æ•ˆ
            canvasCtx.fillStyle = 'rgba(0,0,0,0.5)'; canvasCtx.fillRect(0,0,canvasW,canvasH);
        }

        // 2. æ›´æ–°æ‰‹åŠ¿æ•°æ® (æ¨¡æ‹Ÿæ‰‹åŠ¿æˆ–çœŸå®æ‰‹åŠ¿åœ¨ onResults ä¸­æ›´æ–°ï¼Œè¿™é‡Œå¤„ç†å¹³æ»‘)
        // drawStage1 / drawStage2 é€»è¾‘å¤ç”¨
        
        // æ¸²æŸ“ç²’å­æ‹–å°¾
        canvasCtx.globalCompositeOperation = 'lighter';
        for(var i=sparks.length-1; i>=0; i--) {
            sparks[i].update();
            sparks[i].draw(canvasCtx);
            if(sparks[i].life <= 0) sparks.splice(i, 1);
        }

        if (currentMode === MODE.STAGE_1) {
             // é€»è¾‘ä¸åŸç‰ˆä¸€è‡´ï¼Œçœç•¥è¯¦ç»† drawing ä»£ç ï¼Œç›´æ¥ç”¨ MagicHand æ¸²æŸ“
             magicHands.forEach(function(hand) {
                 var pos = hand.getDrawPos();
                 if (pos.op > 0.01) {
                     canvasCtx.save(); canvasCtx.translate(pos.x, pos.y);
                     canvasCtx.globalCompositeOperation = 'lighter';
                     var op = pos.op; var S = 0.45 * pos.scale;
                     var time = globalTime * 0.02;
                     
                     if (cachedAssets['mandala_outer']) drawCache(canvasCtx, cachedAssets['mandala_outer'], -time*0.4, 1.2*S, op*0.6);
                     if (cachedAssets['mandala_core']) drawCache(canvasCtx, cachedAssets['mandala_core'], time*0.8, 0.8*S, op);
                     // ... æ›´å¤šå±‚çº§çœç•¥ä»¥ä¿æŒç®€æ´
                     
                     canvasCtx.restore();
                     
                     // äº§ç”Ÿç«èŠ±
                     if (hand.active && !window.IS_LOW_END) {
                         for(var k=0; k<2; k++) {
                             sparks.push(new StreakParticle(pos.x, pos.y, theme.hue, Math.random()*6.28, 20+Math.random()*20));
                         }
                     }
                 }
             });
        } else {
            // Stage 2 Logic
            if (s2Cooldown > 0) s2Cooldown--;
            var hasTwoHands = magicHands[0].active && magicHands[1].active;
            var cx = canvasW / 2; var cy = canvasH / 2;
            
            if (hasTwoHands) {
                targetRotY = (((magicHands[0].x+magicHands[1].x)/2 - cx)/(canvasW/2)) * 3.0;
                targetRotX = (((magicHands[0].y+magicHands[1].y)/2 - cy)/(canvasH/2)) * 3.0;
            }
            currentRotX += (targetRotX - currentRotX)*0.1; 
            currentRotY += (targetRotY - currentRotY)*0.1;

            if (s2State === 'IDLE' && hasTwoHands && s2Cooldown <= 0) {
                s2State = 'STABLE';
                activeParticleCount = window.GAME_CONFIG.particleCount;
                for(var p=0; p<activeParticleCount; p++) particlePool[p].spawn(particleType);
                textAlpha = 0;
            } else if (s2State === 'STABLE' && !hasTwoHands) {
                s2State = 'DISPERSING'; disperseStartTime = 0;
            }

            if (s2State !== 'IDLE') {
                var masterOpacity = 1.0;
                if (s2State === 'DISPERSING') {
                    if (disperseStartTime === 0) disperseStartTime = Date.now();
                    var elapsed = Date.now() - disperseStartTime;
                    if (elapsed > 3000) masterOpacity = Math.max(0, 1 - (elapsed - 3000)/1000);
                    if (elapsed > 4000) { s2State = 'IDLE'; s2Cooldown = 60; }
                }

                canvasCtx.globalAlpha = masterOpacity;
                canvasCtx.globalCompositeOperation = 'lighter';
                for (var j = 0; j < activeParticleCount; j++) {
                    particlePool[j].update(s2State === 'DISPERSING', currentRotX, currentRotY);
                    particlePool[j].draw(canvasCtx, cx, cy, theme.hue);
                }
                
                // Text rendering
                canvasCtx.globalCompositeOperation = 'source-over';
                canvasCtx.fillStyle = "rgba(255,255,255,"+ masterOpacity +")";
                canvasCtx.font = "bold 30px Arial";
                canvasCtx.textAlign = "center";
                if (s2State === 'STABLE') canvasCtx.fillText(PARTICLE_CONFIG[particleType].text1, cx, cy - 200);
                if (s2State === 'DISPERSING') canvasCtx.fillText(PARTICLE_CONFIG[particleType].text2, cx, cy);
                canvasCtx.globalAlpha = 1.0;
            }
        }

        window.requestAnimFrame(renderLoop);
    }

    // === è§†è§‰ä¿®æ­£ï¼šObject-Fit Cover ç®—æ³• ===
    // ä¿®å¤ï¼šæ‰‹åŠ¿åæ ‡åœ¨ä¸åŒæ¯”ä¾‹å±å¹•ä¸Šçš„é”™ä½é—®é¢˜
    function computeAdaptiveCoords(normX, normY) {
        // MediaPipe è¾“å‡ºæ˜¯å½’ä¸€åŒ–çš„ (0~1)ï¼ŒåŸºäºè¾“å…¥è§†é¢‘ (é€šå¸¸ 4:3, e.g. 640x480)
        // å±å¹•æ˜¯ä»»æ„æ¯”ä¾‹ (e.g. 16:9, 19.5:9)
        // æˆ‘ä»¬å‡è®¾ä½¿ç”¨ object-fit: cover å¡«å……å±å¹•
        
        var screenRatio = canvasW / canvasH;
        var videoRatio = window.GAME_CONFIG.videoW / window.GAME_CONFIG.videoH; // 4/3
        
        var scale, offsetX, offsetY;
        
        if (screenRatio > videoRatio) {
            // å±å¹•æ›´å®½ï¼ˆç”µè„‘ï¼‰ï¼Œè§†é¢‘ä¸Šä¸‹è¢«è£ï¼ˆå®é™…ä¸Šä¸ä¼šï¼Œcoveræ˜¯å¡«æ»¡ï¼‰
            // Cover: è§†é¢‘å®½åº¦é€‚é…å±å¹•å®½åº¦ï¼Œé«˜åº¦æº¢å‡ºè¢«è£
            scale = canvasW / window.GAME_CONFIG.videoW;
            var renderH = window.GAME_CONFIG.videoH * scale;
            offsetY = (renderH - canvasH) / 2;
            offsetX = 0;
            
            return {
                x: normX * canvasW,
                y: (normY * renderH) - offsetY
            };
        } else {
            // å±å¹•æ›´çª„ï¼ˆæ‰‹æœºï¼‰ï¼Œè§†é¢‘å·¦å³è¢«è£
            // Cover: è§†é¢‘é«˜åº¦é€‚é…å±å¹•é«˜åº¦ï¼Œå®½åº¦æº¢å‡º
            scale = canvasH / window.GAME_CONFIG.videoH;
            var renderW = window.GAME_CONFIG.videoW * scale;
            offsetX = (renderW - canvasW) / 2;
            offsetY = 0;
            
            return {
                x: (normX * renderW) - offsetX,
                y: normY * canvasH,
                scale: scale // ä¿å­˜ç¼©æ”¾æ¯”ä¾‹ç”¨äºæ‰‹çš„å¤§å°è®¡ç®—
            };
        }
    }

    // === MediaPipe å¤„ç† ===
    var frameCount = 0;
    
    function onResults(results) {
        // æ›´æ–°æ‰‹åŠ¿çŠ¶æ€
        var detectedHands = [];
        if (results.multiHandLandmarks) {
            for (var i = 0; i < results.multiHandLandmarks.length; i++) {
                var lm = results.multiHandLandmarks[i];
                // ä½¿ç”¨ç´¢å¼•9 (ä¸­æŒ‡æ ¹éƒ¨) ä½œä¸ºæ‰‹å¿ƒ
                var center = lm[9];
                var wrist = lm[0];
                
                // åº”ç”¨è§†è§‰ä¿®æ­£ç®—æ³•
                var coords = computeAdaptiveCoords(1.0 - center.x, center.y); // é•œåƒ X
                
                // ç®€å•çš„æ·±åº¦ä¼°ç®—
                var size = Math.hypot(center.x - wrist.x, center.y - wrist.y);
                detectedHands.push({ x: coords.x, y: coords.y, scale: size * 5 }); // æ”¾å¤§å› å­
            }
        }
        
        // æ›´æ–°é­”æœ¯æ‰‹å¯¹è±¡
        if (detectedHands.length > 0) magicHands[0].update(detectedHands[0]); else magicHands[0].update(null);
        if (detectedHands.length > 1) magicHands[1].update(detectedHands[1]); else magicHands[1].update(null);
        
        // æ›´æ–° UI æç¤º
        if (currentMode === MODE.STAGE_1) {
            instructionText.innerText = detectedHands.length < 2 ? "Show two hands to activate" : "Magic Active";
        }
    }

    // === æ ¸å¿ƒé€»è¾‘ï¼šPromise é“¾å¼å¯åŠ¨ (è¯­æ³•é™çº§) ===
    function startApp() {
        // 1. éšè—é®ç½©
        document.getElementById('start-overlay').style.display = 'none';
        document.getElementById('loading').style.opacity = 1;
        loadingDiv.innerText = "INITIALIZING NEURAL NET...";

        // 2. åˆå§‹åŒ– MediaPipe
        // ä¿®å¤ï¼šé”å®šç‰ˆæœ¬å·ï¼Œé˜²æ­¢ CDN 404 é”™è¯¯
        handsInstance = new Hands({locateFile: function(file) {
            return "https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/" + file;
        }});

        handsInstance.setOptions({
            maxNumHands: 2,
            modelComplexity: window.IS_LOW_END ? 0 : 1, // ä½ç«¯æœºä½¿ç”¨è½»é‡æ¨¡å‹
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        handsInstance.onResults(onResults);

        // 3. å¯åŠ¨æ‘„åƒå¤´
        var camera = new Camera(videoElement, {
            onFrame: function() {
                frameCount++;
                // æ€§èƒ½ä¼˜åŒ–ï¼šæ ¹æ®é…ç½®è¿›è¡ŒèŠ‚æµ (Throttle)
                if (frameCount % window.GAME_CONFIG.aiInterval === 0) {
                    return handsInstance.send({image: videoElement});
                }
                return Promise.resolve();
            },
            width: window.GAME_CONFIG.videoW,
            height: window.GAME_CONFIG.videoH
        });

        // ä¿®å¤ï¼šä½¿ç”¨ .then/.catch æ›¿ä»£ async/await
        camera.start()
            .then(function() {
                loadingDiv.style.opacity = 0;
                initParticlePool();
                generateCache();
                renderLoop(); // å¼€å§‹æ¸²æŸ“å¾ªç¯
            })
            .catch(function(e) {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + e.message);
                loadingDiv.innerText = "CAMERA ERROR";
            });
    }

    // === è¾“å…¥å¤„ç† ===
    function handleInput(key) {
        var k = key.toLowerCase();
        if (k === '1') { currentMode = 1; isBlackBackground = false; }
        if (k === '2') { currentMode = 2; isBlackBackground = true; s2State = 'IDLE'; }
        if (k === '3') { if(currentMode===1) shapeType=0; else particleType=0; }
        if (k === '4') { if(currentMode===1) shapeType=1; else particleType=1; }
        if (k === '5') { if(currentMode===1) shapeType=2; else particleType=2; }
        if (k === 'q') colorType = 0;
        if (k === 'w') colorType = 1;
        if (k === 'e') colorType = 2;
        if (k === '0') isBlackBackground = !isBlackBackground;
        
        // é‡æ–°ç”Ÿæˆç¼“å­˜
        if (['q','w','e'].indexOf(k) > -1) {
            setTimeout(generateCache, 10);
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById('k1').className = "key-badge " + (currentMode===1?'mode-active':'');
        document.getElementById('k2').className = "key-badge " + (currentMode===2?'mode-active':'');
        var theme = COLOR_THEMES[colorType];
        bgKey.className = "key-badge " + (isBlackBackground?'bg-active':'');
        document.getElementById('kq').className = "key-badge " + (colorType===0?'mode-active':'');
        document.getElementById('kw').className = "key-badge " + (colorType===1?'mode-active':'');
        document.getElementById('ke').className = "key-badge " + (colorType===2?'mode-active':'');
    }

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    var clickMap = {'k1':'1', 'k2':'2', 'k3':'3', 'k4':'4', 'k5':'5', 'kq':'q', 'kw':'w', 'ke':'e', 'k0':'0'};
    Object.keys(clickMap).forEach(function(id) {
        var el = document.getElementById(id);
        if(el) {
            el.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                handleInput(clickMap[id]);
            });
            // å¢åŠ è§¦æ‘¸åé¦ˆ
            el.addEventListener('touchstart', function(e) { e.stopPropagation(); }, {passive: false});
        }
    });

</script>
</body>
</html>
