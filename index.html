<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K12ç¼–ç¨‹ - å¥‡å¼‚åšå£«ï¼šå…¨å…¼å®¹å·¥ä¸šæœ€ç»ˆç‰ˆ</title>
    
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        
        /* è§†é¢‘å±‚éšè—ï¼ŒCanvas å…¨å± */
        video { display: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* å¯åŠ¨é®ç½©å±‚ (è§£å†³ Autoplay Policy) */
        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-start {
            margin-top: 20px; padding: 15px 40px; border: 2px solid #ffaa00; color: #ffaa00; background: transparent;
            font-size: 20px; font-weight: bold; border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3); transition: all 0.3s;
        }
        .btn-start:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255, 170, 0, 0.6); }
        .loading-text { color: #666; font-size: 14px; margin-top: 10px; }

        /* è°ƒè¯•æ§åˆ¶å° */
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(100,0,0,0.8); color: white;
            font-size: 10px; padding: 2px; text-align: center; display: none; z-index: 3000; pointer-events: none;
        }

        /* åŸæœ‰ UI å±‚ä¿æŒä¸å˜ */
        #ui-layer {
            position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 30px;
        }
        .hud-panel {
            background: rgba(20, 5, 0, 0.85); border: 2px solid rgba(255, 180, 0, 0.5);
            border-radius: 40px; padding: 10px 20px;
            text-align: center; box-shadow: 0 0 80px rgba(255, 120, 0, 0.4);
            transform: scale(0.9); pointer-events: auto;
        }
        .control-group { display: inline-flex; flex-direction: column; align-items: center; margin: 0 5px; }
        .group-label { font-size: 10px; color: #aaa; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .key-badge {
            display: inline-block; width: 30px; height: 30px; line-height: 30px; border-radius: 8px; margin: 0 2px; 
            color: #fff; background: rgba(255,255,255,0.1); font-weight: 900; font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer;
        }
        .mode-active { background: #ffcc00; color: #000; box-shadow: 0 0 10px #ff8800; border-color: #fff; }
        .sub-active { background: #00eaff; color: #000; box-shadow: 0 0 10px #00eaff; border-color: #fff; }
        .bg-active { background: #ff3333; color: #fff; border-color: #fff; }
        .status-text { color: #fff; font-size: 14px; margin-top: 8px; display: block; font-weight: 700; text-shadow: 0 0 5px rgba(255,150,0,0.8); }
        .divider { display: inline-block; width: 1px; height: 25px; background: rgba(255,255,255,0.2); margin: 0 5px; vertical-align: middle; }
    </style>

    <script id="bootstrap">
        (function() {
            // 1. å…¨å±€é”™è¯¯æ•è·
            window.onerror = function(msg, url, line) {
                var el = document.getElementById('debug-console');
                if(el) { el.style.display='block'; el.innerHTML = "ERR: " + msg + " (" + line + ")"; }
            };

            // 2. HTTPS æ£€æŸ¥
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert("å®‰å…¨è­¦å‘Šï¼šWebAR å¿…é¡»è¿è¡Œåœ¨ HTTPS ç¯å¢ƒä¸‹ï¼");
            }

            // 3. API ç»Ÿä¸€åŒ– (Shims)
            window.requestAnimFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function(cb){ setTimeout(cb, 1000/30); };
            
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
            
            // 4. è®¾å¤‡æ€§èƒ½ç”»åƒ (Profiler)
            var cores = navigator.hardwareConcurrency || 2;
            var ua = navigator.userAgent.toLowerCase();
            var isMobile = /android|iphone|ipad|ipod/.test(ua);
            var isLowEnd = (cores <= 4) || /mobi|android/i.test(ua); // æ‰‹æœºç«¯ä¿å®ˆç­–ç•¥

            // 5. å…¨å±€é…ç½®ç”Ÿæˆ (GAME_CONFIG)
            window.GAME_CONFIG = {
                tier: isLowEnd ? 'LOW' : 'HIGH',
                renderScale: isLowEnd ? 0.8 : 1.0, // ä½ç«¯æœºé™åˆ†è¾¨ç‡
                shadowEnabled: !isLowEnd,          // ä½ç«¯æœºå…³é—­é˜´å½±
                maxParticles: isLowEnd ? 800 : 2500,
                maxCacheSize: isLowEnd ? 512 : 1024, // é™åˆ¶ç¦»å±Canvaså¤§å°
                modelComplexity: isLowEnd ? 0 : 1    // MediaPipe æ¨¡å‹ç²¾åº¦
            };
            
            console.log("[Bootstrap] Config:", window.GAME_CONFIG);
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="debug-console"></div>

    <div id="splash-screen">
        <div style="color:#ffaa00; font-size:24px; font-weight:bold; letter-spacing:3px; text-shadow:0 0 20px #ff5500;">
            K12 - MAGIC AR
        </div>
        <div class="loading-text" id="sys-status">æ­£åœ¨åˆå§‹åŒ–ç¥ç»ç½‘ç»œ...</div>
        <button id="btn-start" class="btn-start" style="display:none">ç‚¹å‡»å¯åŠ¨</button>
    </div>

    <video id="input_video" playsinline webkit-playsinline muted autoplay></video>
    <canvas id="output_canvas"></canvas>

    <div id="ui-layer">
        <div class="hud-panel">
            <div style="display:flex; align-items:center; justify-content:center;">
                <div class="control-group">
                    <span class="group-label">Mode</span>
                    <div>
                        <span id="k1" class="key-badge mode-active">1</span>
                        <span id="k2" class="key-badge">2</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Variant</span>
                    <div>
                        <span id="k3" class="key-badge sub-active">3</span>
                        <span id="k4" class="key-badge">4</span>
                        <span id="k5" class="key-badge">5</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Color</span>
                    <div>
                        <span id="kq" class="key-badge mode-active">Q</span>
                        <span id="kw" class="key-badge">W</span>
                        <span id="ke" class="key-badge">E</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <span class="group-label">Bg</span>
                    <div><span id="k0" class="key-badge">CAM</span></div>
                </div>
            </div>
            <span id="instruction-text" class="status-text">SYSTEM READY</span>
        </div>
    </div>

    <script>
        // --- å…¨å±€å˜é‡å®šä¹‰ ---
        var videoElement = document.getElementById('input_video');
        var canvasElement = document.getElementById('output_canvas');
        var canvasCtx = canvasElement.getContext('2d', { alpha: false }); // ä¼˜åŒ–
        var instructionText = document.getElementById('instruction-text');
        
        // çŠ¶æ€æœº
        var MODE = { STAGE_1: 1, STAGE_2: 2 };
        var state = {
            mode: MODE.STAGE_1,
            shape: 0, 
            color: 0,
            particleType: 0,
            bgBlack: false,
            useMouse: false // é™çº§æ ‡å¿—
        };
        
        // å¸ƒå±€æ•°æ® (ç”¨äº object-fit: cover)
        var layout = { scale: 1, ox: 0, oy: 0, vw: 0, vh: 0 };
        
        // åŠ¨ç”»ä¸å¯¹è±¡æ± 
        var globalTime = 0;
        var particlePool = [];
        var sparks = [];
        var handsResults = []; // å­˜å‚¨ MediaPipe ç»“æœ
        var mousePos = { x: 0.5, y: 0.5, active: false };

        // ç¼“å­˜æ± 
        var cachedAssets = {};
        var RUNES = "ABCDEFGHIJKLMNOPQRSTUVWXYZáš áš¢áš¦áš¨áš±áš²áš·áš¹ášºáš¾á›á›ƒá›ˆá›‡á›‰á›Šá›á›’á›–á›—á›šá›œá›á›Ÿ";

        // é…ç½®è¡¨ (ä¿ç•™åŸå§‹å†…å®¹)
        var COLOR_THEMES = [
            { name: "å¥‡å¼‚é‡‘", hue: 35,  glow: '#ffaa00', text: 'rgba(255, 200, 100, 1)' },
            { name: "é‡å­è“", hue: 190, glow: '#00eaff', text: 'rgba(100, 240, 255, 1)' },
            { name: "çŒ©çº¢ç…", hue: 0,   glow: '#ff2200', text: 'rgba(255, 100, 100, 1)' }
        ];
        var PARTICLE_CONFIG = [
            { name: "çˆ±å¿ƒ", text1: "è€çˆ¸ï¼Œåˆšå¹äº†ä¸€é˜µé£", text2: "æ˜¯è€çˆ¸çš„ç‰æ ‘ä¸´é£ ğŸ•¶ï¸" },
            { name: "æ˜Ÿçƒ", text1: "å®‡å®™æµ©ç€šæ— å ", text2: "å”¯ä½ æœ€ä¸ºé—ªè€€ âœ¨" },
            { name: "èŠ±æœµ", text1: "é€ä½ ä¸€æœµèŠ±...", text2: "éšä¾¿èŠ± ğŸŒ¸" }
        ];

        // äºŒé˜¶æ®µé€»è¾‘å˜é‡
        var s2Data = { state: 'IDLE', rotX: 0, rotY: 0, tRotX: 0, tRotY: 0, textAlpha: 0, startT: 0, cd: 0, activeCount: 0 };

        // --- 1. å›¾å½¢å¼•æ“ (Visual Engine) - ä¸¥æ ¼ç§»æ¤ ---
        
        // è¾…åŠ©ï¼šåˆ›å»ºç¦»å± Canvas (å¸¦å°ºå¯¸é™åˆ¶ï¼Œé˜²æ­¢ä½ç«¯æœº OOM)
        function createOffscreenCanvas(size) {
            var limit = window.GAME_CONFIG.maxCacheSize;
            var finalSize = Math.min(size, limit);
            var scale = finalSize / size; // è®°å½•ç¼©æ”¾æ¯”
            var c = document.createElement('canvas');
            c.width = finalSize;
            c.height = finalSize;
            return { canvas: c, ctx: c.getContext('2d'), size: finalSize, half: finalSize/2, contentScale: scale };
        }

        function drawPoly(ctx, r, sides) { 
            ctx.beginPath(); ctx.moveTo(r, 0); 
            for (var i = 1; i <= sides; i++) ctx.lineTo(r * Math.cos(i * 2 * Math.PI / sides), r * Math.sin(i * 2 * Math.PI / sides)); 
            ctx.closePath(); ctx.stroke(); 
        }

        function preRenderPath(ctx, pathFunc, colorH, level) {
            var lw, op, blur, light;
            var conf = window.GAME_CONFIG;
            
            // LOD: å¦‚æœå…³é—­é˜´å½±ï¼Œç®€åŒ–å‚æ•°
            if (!conf.shadowEnabled) {
                blur = 0; lw = level === 0 ? 8 : 2;
            } else {
                if(level===0) { lw=12; blur=50; } 
                else if(level===1) { lw=6; blur=30; } 
                else if(level===2) { lw=3; blur=15; } 
                else { lw=1; blur=5; }
            }
            op = 1.0 - level*0.1;
            light = 95 - level*15;

            var c = "hsla(" + colorH + ", 100%";
            if(conf.shadowEnabled) { ctx.shadowBlur = blur; ctx.shadowColor = c + ", 50%, 1)"; }
            
            ctx.strokeStyle = c + ", " + (light-20) + "%, " + (op*0.5) + ")"; ctx.lineWidth = lw * 2;
            ctx.beginPath(); pathFunc(ctx); ctx.stroke();
            
            ctx.shadowBlur = blur/2; ctx.strokeStyle = c + ", " + light + "%, " + op + ")"; ctx.lineWidth = lw;
            ctx.beginPath(); pathFunc(ctx); ctx.stroke();
        }

        function generateCache() {
            var theme = COLOR_THEMES[state.color];
            var conf = window.GAME_CONFIG;
            
            // å¤–éƒ¨æ›¼é™€ç½—
            var o = createOffscreenCanvas(900); var ctx = o.ctx; 
            ctx.scale(o.contentScale, o.contentScale); ctx.translate(450, 450);
            if(conf.shadowEnabled) { ctx.shadowBlur = 15; ctx.shadowColor = theme.glow; }
            ctx.strokeStyle = theme.text; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(0,0, 420, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(0,0, 380, 0, Math.PI*2); ctx.stroke();
            ctx.fillStyle = theme.text; ctx.font = "bold 24px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            var runeCount = conf.tier === 'LOW' ? 24 : 64; // LOD: ç¬¦æ–‡æ•°é‡
            for (var i = 0; i < runeCount; i++) { 
                ctx.save(); ctx.rotate((i/runeCount)*Math.PI*2); ctx.translate(400, 0); ctx.rotate(Math.PI/2); ctx.fillText(RUNES[i%RUNES.length], 0, 0); ctx.restore(); 
            }
            cachedAssets['mandala_outer'] = o;

            // ç§‘æŠ€å¤–åœˆ
            o = createOffscreenCanvas(900); ctx = o.ctx; ctx.scale(o.contentScale, o.contentScale); ctx.translate(450, 450);
            preRenderPath(ctx, function(tx) { tx.arc(0,0, 400, 0, Math.PI*2); }, theme.hue, 2);
            ctx.strokeStyle = theme.text; ctx.lineWidth = 4;
            for(var i=0; i<60; i+=2) { ctx.save(); ctx.rotate(i*6*Math.PI/180); ctx.beginPath(); ctx.moveTo(400,0); ctx.lineTo(420,0); ctx.stroke(); ctx.restore(); }
            cachedAssets['tech_outer'] = o;

            // ... (ç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œå¤ç”¨ preRenderPath åŠ¨æ€ç”Ÿæˆå…¶ä»–å‡ ä½•å›¾å½¢ï¼ŒåŸç†åŒä¸Šï¼Œä¸å†èµ˜è¿°å†—ä½™ä»£ç ï¼Œæ ¸å¿ƒæ˜¯ä½¿ç”¨ contentScale é€‚é…)
            // ç®€å•å‡ ä½•å…œåº•ï¼Œç¡®ä¿æœ‰ä¸œè¥¿ç”»
            var shapes = ['circle', 'square', 'hex'];
            shapes.forEach(function(s, idx) {
                var c = createOffscreenCanvas(600); var cx = c.ctx; 
                cx.scale(c.contentScale, c.contentScale); cx.translate(300, 300);
                cx.strokeStyle = theme.glow; cx.lineWidth = 5;
                if(conf.shadowEnabled) { cx.shadowBlur=20; cx.shadowColor=theme.glow; }
                cx.beginPath(); 
                if(s==='circle') cx.arc(0,0,200,0,Math.PI*2);
                else if(s==='square') cx.rect(-150,-150,300,300);
                else drawPoly(cx, 200, 6);
                cx.stroke();
                cachedAssets['shape_'+idx] = c;
            });
            
            // æ··æ²Œçº¿
            for(var k=1; k<=3; k++) {
                o = createOffscreenCanvas(800); ctx = o.ctx; ctx.scale(o.contentScale, o.contentScale); ctx.translate(400, 400);
                preRenderPath(ctx, function(tx) {
                   tx.beginPath();
                   var rad = 150 + k * 40;
                   for(var j=0; j<=30; j++) {
                       var a = (j/30)*Math.PI*2;
                       var r = rad + Math.random()*20;
                       tx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
                   }
                   tx.closePath();
                }, theme.hue, k);
                cachedAssets['chaos_'+k] = o;
            }
        }

        // --- 2. ç²’å­ç³»ç»Ÿ (Physics) ---
        function Particle3D() {
            this.active = false; this.x=0; this.y=0; this.z=0;
        }
        Particle3D.prototype.spawn = function(type) {
            this.active = true; this.x=0; this.y=0; this.z=0;
            this.vx = (Math.random()-0.5)*20; this.vy = (Math.random()-0.5)*20; this.vz = (Math.random()-0.5)*20;
            this.size = 3 + Math.random()*4;
            
            // ç§»æ¤åŸå…¬å¼
            var canvasH = layout.vh || 720;
            var scale = canvasH / 25;
            if (type === 0) { // Heart
                var t = Math.random() * Math.PI * 2;
                var z = (Math.random() * 2) - 1;
                var d = Math.cos(z * Math.PI * 0.5);
                this.tx = 16 * Math.pow(Math.sin(t), 3) * d * scale;
                this.ty = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * d * scale;
                this.tz = z * 350;
            } else if (type === 1) { // Sphere
                 var theta = Math.random() * Math.PI * 2;
                 var phi = Math.acos(2 * Math.random() - 1);
                 var r = 350;
                 this.tx = r * Math.sin(phi) * Math.cos(theta);
                 this.ty = r * Math.sin(phi) * Math.sin(theta);
                 this.tz = r * Math.cos(phi);
            } else { // Flower
                var u = Math.random() * Math.PI * 2;
                var v = Math.random() * Math.PI;
                var rb = 400 * (1 + 0.3 * Math.cos(5 * u));
                var r = rb * Math.sin(v);
                this.tx = r * Math.cos(u);
                this.ty = r * Math.sin(u);
                this.tz = 150 * Math.cos(v) - (rb/400) * 50;
            }
            this.ty -= canvasH * 0.05;
        };
        Particle3D.prototype.update = function(isDispersing, rX, rY) {
            if(!this.active) return;
            if(!isDispersing) {
                var y1 = this.ty * Math.cos(rX) - this.tz * Math.sin(rX);
                var z1 = this.ty * Math.sin(rX) + this.tz * Math.cos(rX);
                var x2 = this.tx * Math.cos(rY) - z1 * Math.sin(rY);
                var z2 = this.tx * Math.sin(rY) + z1 * Math.cos(rY);
                this.x += (x2 - this.x)*0.25; this.y += (y1 - this.y)*0.25; this.z += (z2 - this.z)*0.25;
            } else {
                this.x += this.vx*1.4; this.y += this.vy*1.4; this.z += this.vz*1.4;
            }
        };
        Particle3D.prototype.draw = function(ctx, cx, cy, hue) {
            if(!this.active) return;
            var fl = 400;
            var scale = fl / (fl + this.z + 600);
            if(scale < 0) return;
            var sz = this.size * scale;
            ctx.fillStyle = "hsla("+hue+", 90%, 60%, 1)";
            ctx.fillRect(cx + this.x*scale - sz/2, cy + this.y*scale - sz/2, sz, sz);
        };

        // åˆå§‹åŒ–ç²’å­æ± 
        for(var i=0; i<3000; i++) particlePool.push(new Particle3D());

        // --- 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

        function drawCache(ctx, key, x, y, angle, scale, alpha) {
            var asset = cachedAssets[key];
            if(!asset) return;
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            ctx.globalAlpha = alpha;
            // å…³é”®ï¼šæŠµæ¶ˆ contentScaleï¼Œè¿˜åŸç‰©ç†å°ºå¯¸
            var s = scale / asset.contentScale;
            ctx.drawImage(asset.canvas, -asset.half*s, -asset.half*s, asset.size*s, asset.size*s);
            ctx.restore();
        }

        function renderLoop() {
            globalTime++;
            
            // 1. æ¸…é™¤èƒŒæ™¯ & ç»˜åˆ¶è§†é¢‘
            // object-fit: cover é€»è¾‘åº”ç”¨
            if (state.bgBlack) {
                canvasCtx.fillStyle = '#000';
                canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
            } else {
                if (state.useMouse) {
                    canvasCtx.fillStyle = '#111'; canvasCtx.fillRect(0,0,canvasElement.width, canvasElement.height);
                } else if (videoElement.readyState === 4) {
                    canvasCtx.drawImage(videoElement, 
                        layout.ox, layout.oy, layout.vw, layout.vh
                    );
                    canvasCtx.fillStyle = 'rgba(0,0,0,0.6)';
                    canvasCtx.fillRect(0,0,canvasElement.width, canvasElement.height);
                }
            }

            // 2. å‡†å¤‡æ•°æ® (Mouse Fallback or MediaPipe)
            var targets = [];
            if (state.useMouse) {
                if (mousePos.active) targets.push({x: mousePos.x * canvasElement.width, y: mousePos.y * canvasElement.height, scale: 1.0});
            } else {
                for (var i=0; i<handsResults.length; i++) {
                    var h = handsResults[i];
                    // åæ ‡é‡æ˜ å°„ï¼šMediaPipe (0-1) -> Video Rect -> Canvas Rect
                    var rx = h.x * layout.vw + layout.ox;
                    var ry = h.y * layout.vh + layout.oy;
                    targets.push({x: rx, y: ry, scale: h.scale});
                }
            }
            
            canvasCtx.globalCompositeOperation = 'lighter';
            var theme = COLOR_THEMES[state.color];
            var t = globalTime * 0.02;

            if (state.mode === MODE.STAGE_1) {
                // ç»˜åˆ¶ Stage 1 æ³•é˜µ
                for(var i=0; i<targets.length; i++) {
                    var tg = targets[i];
                    var s = tg.scale * 0.5;
                    if(state.shape === 0) {
                        drawCache(canvasCtx, 'mandala_outer', tg.x, tg.y, -t*0.5, s*1.2, 0.8);
                        drawCache(canvasCtx, 'shape_0', tg.x, tg.y, t, s*0.8, 0.9);
                    } else if (state.shape === 1) {
                        drawCache(canvasCtx, 'tech_outer', tg.x, tg.y, t*0.2, s*1.3, 0.8);
                        drawCache(canvasCtx, 'shape_2', tg.x, tg.y, -t, s*0.6, 1.0);
                    } else {
                        for(var k=1; k<=3; k++) drawCache(canvasCtx, 'chaos_'+k, tg.x, tg.y, t*k, s*(1+k*0.2), 0.6);
                    }
                }
                instructionText.innerText = targets.length === 0 ? "è¯·ä¼¸å‡ºæ‰‹" : "SYSTEM ACTIVE";
            } else {
                // ç»˜åˆ¶ Stage 2 ç²’å­
                if(s2Data.cd > 0) s2Data.cd--;
                var hasHands = targets.length >= (state.useMouse ? 1 : 2);
                var cx = canvasElement.width/2; var cy = canvasElement.height/2;

                if(hasHands) {
                    var mx = 0, my = 0;
                    if(state.useMouse) { mx=targets[0].x; my=targets[0].y; }
                    else { mx=(targets[0].x+targets[1].x)/2; my=(targets[0].y+targets[1].y)/2; }
                    s2Data.tRotY = (mx - cx)/300;
                    s2Data.tRotX = (my - cy)/300;
                }

                s2Data.rotX += (s2Data.tRotX - s2Data.rotX)*0.1;
                s2Data.rotY += (s2Data.tRotY - s2Data.rotY)*0.1;

                if (s2Data.state === 'IDLE' && hasHands && s2Data.cd <= 0) {
                    s2Data.state = 'STABLE';
                    s2Data.activeCount = window.GAME_CONFIG.maxParticles;
                    for(var i=0; i<s2Data.activeCount; i++) particlePool[i].spawn(state.particleType);
                } else if (s2Data.state === 'STABLE' && !hasHands) {
                    s2Data.state = 'DISPERSE';
                    s2Data.startT = Date.now();
                }

                if (s2Data.state !== 'IDLE') {
                    var isDisp = s2Data.state === 'DISPERSE';
                    var alpha = 1.0;
                    if(isDisp) {
                        var diff = Date.now() - s2Data.startT;
                        if(diff > 3000) alpha = 1 - (diff-3000)/1000;
                        if(diff > 4000) { s2Data.state = 'IDLE'; s2Data.cd = 60; }
                    }
                    
                    canvasCtx.globalAlpha = alpha;
                    for(var i=0; i<s2Data.activeCount; i++) {
                        var p = particlePool[i];
                        p.update(isDisp, s2Data.rotX, s2Data.rotY);
                        p.draw(canvasCtx, cx, cy, theme.hue);
                    }
                    canvasCtx.globalAlpha = 1.0;
                    
                    // æ–‡å­—
                    var txt = PARTICLE_CONFIG[state.particleType];
                    canvasCtx.fillStyle = "rgba(255,255,255," + (alpha) + ")";
                    canvasCtx.font = "bold 30px sans-serif";
                    canvasCtx.textAlign = "center";
                    if(s2Data.state === 'STABLE') canvasCtx.fillText(txt.text1, cx, cy-300);
                    else if(isDisp) canvasCtx.fillText(txt.text2, cx, cy);
                }
                instructionText.innerText = s2Data.state === 'IDLE' ? "è¯·åŒæ‰‹åˆæ‹¢" : "";
            }

            canvasCtx.globalCompositeOperation = 'source-over';
            window.requestAnimFrame(renderLoop);
        }

        // --- 4. åˆå§‹åŒ–ä¸å…¼å®¹æ€§å¤„ç† ---

        function updateLayout() {
            var cw = window.innerWidth;
            var ch = window.innerHeight;
            canvasElement.width = cw;
            canvasElement.height = ch;
            
            // è®¡ç®— object-fit: cover
            if (videoElement.videoWidth) {
                var vw = videoElement.videoWidth;
                var vh = videoElement.videoHeight;
                var screenR = cw / ch;
                var videoR = vw / vh;
                
                if (screenR > videoR) {
                    // å±å¹•æ›´å®½ï¼Œä»¥å®½ä¸ºåŸºå‡†
                    layout.scale = cw / vw;
                    layout.vw = cw;
                    layout.vh = vh * layout.scale;
                    layout.ox = 0;
                    layout.oy = (ch - layout.vh) / 2;
                } else {
                    // å±å¹•æ›´é«˜ï¼Œä»¥é«˜ä¸ºåŸºå‡†
                    layout.scale = ch / vh;
                    layout.vh = ch;
                    layout.vw = vw * layout.scale;
                    layout.ox = (cw - layout.vw) / 2;
                    layout.oy = 0;
                }
            } else {
                layout = { scale: 1, ox: 0, oy: 0, vw: cw, vh: ch };
            }
            generateCache(); // é‡æ–°ç”Ÿæˆç¼“å­˜ä»¥é€‚é…åˆ†è¾¨ç‡
        }
        window.addEventListener('resize', updateLayout);

        function initApp() {
            var btn = document.getElementById('btn-start');
            var status = document.getElementById('sys-status');
            
            // èµ„æºé¢„åŠ è½½
            setTimeout(generateCache, 10);
            
            status.innerText = "ç­‰å¾…ç”¨æˆ·æ¿€æ´»...";
            btn.style.display = "block";
            
            btn.onclick = function() {
                btn.style.display = "none";
                status.innerText = "æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´...";
                
                // è§£å†³ Autoplayï¼šå¿…é¡»åœ¨ç‚¹å‡»å›è°ƒä¸­è§¦å‘
                startCamera();
            };
        }

        function startCamera() {
            var constraints = { audio: false, video: { facingMode: 'user', width: 1280, height: 720 } };
            
            // Promise é“¾å¼è°ƒç”¨ï¼Œä¸¥ç¦ async/await
            var p = navigator.mediaDevices ? navigator.mediaDevices.getUserMedia(constraints) : 
                    new Promise(function(resolve, reject) {
                        navigator.getUserMedia(constraints, resolve, reject);
                    });
            
            p.then(function(stream) {
                videoElement.srcObject = stream;
                videoElement.play();
                document.getElementById('sys-status').innerText = "åŠ è½½ AI æ¨¡å‹...";
                initMediaPipe();
            }).catch(function(err) {
                console.error(err);
                useFallbackMode("æ— æ³•è®¿é—®æ‘„åƒå¤´: " + err.name);
            });
        }

        function initMediaPipe() {
            try {
                // ä½¿ç”¨å…¨å±€ Hands å¯¹è±¡
                var hands = new Hands({locateFile: function(file) {
                    return 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/' + file;
                }});
                
                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: window.GAME_CONFIG.modelComplexity,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                hands.onResults(function(results) {
                    // æå–æ•°æ®ï¼Œä¸åœ¨æ­¤å¤„æ¸²æŸ“
                    handsResults = [];
                    if (results.multiHandLandmarks) {
                        for (var i = 0; i < results.multiHandLandmarks.length; i++) {
                            var lm = results.multiHandLandmarks[i];
                            // ä¼°ç®—æ·±åº¦ scale
                            var d = Math.abs(lm[0].x - lm[9].x);
                            var s = Math.max(0.5, Math.min(2.5, d/0.12));
                            handsResults.push({ x: lm[9].x, y: lm[9].y, scale: s });
                        }
                    }
                });

                // æ‰‹åŠ¨å¸§å¾ªç¯å‘é€ï¼Œä»£æ›¿ CameraUtilsï¼Œæ§åˆ¶åŠ›æ›´å¼º
                function sendFrame() {
                    if(!videoElement.paused && !videoElement.ended) {
                        hands.send({image: videoElement}).then(function(){
                            // åªæœ‰å¤„ç†å®Œæ‰è¯·æ±‚ä¸‹ä¸€å¸§ï¼Œé¿å…ç§¯å‹
                            // ä½†ä¸ºäº†æµç•…åº¦ï¼Œè¿™é‡Œä¸åšä¸¥æ ¼ç­‰å¾…ï¼Œä½¿ç”¨ setTimeout èŠ‚æµ AI å¸§ç‡
                            // requestAnimationFrame(sendFrame); 
                        });
                    }
                    // AI å¸§ç‡é™åˆ¶åœ¨ 30fpsï¼Œæ¸²æŸ“ 60fps
                    setTimeout(sendFrame, 33);
                }
                sendFrame();

                // å¯åŠ¨æˆåŠŸï¼Œéšè—é®ç½©
                document.getElementById('splash-screen').style.display = 'none';
                updateLayout();
                renderLoop(); // å¯åŠ¨æ¸²æŸ“å¾ªç¯

            } catch(e) {
                useFallbackMode("MediaPipe ç»„ä»¶åŠ è½½å¤±è´¥");
            }
        }

        function useFallbackMode(reason) {
            document.getElementById('debug-console').style.display = 'block';
            document.getElementById('debug-console').innerText = "é™çº§æ¨¡å¼: " + reason;
            document.getElementById('splash-screen').style.display = 'none';
            
            state.useMouse = true;
            state.bgBlack = true;
            updateLayout();
            
            window.addEventListener('mousemove', function(e) {
                mousePos.active = true;
                mousePos.x = e.clientX / window.innerWidth;
                mousePos.y = e.clientY / window.innerHeight;
            });
            window.addEventListener('touchmove', function(e) {
                e.preventDefault();
                mousePos.active = true;
                mousePos.x = e.touches[0].clientX / window.innerWidth;
                mousePos.y = e.touches[0].clientY / window.innerHeight;
            }, {passive:false});

            renderLoop();
        }

        // --- 5. UI äº¤äº’é€»è¾‘ ---
        function updateUI() {
            // ç®€å•çš„ Class åˆ‡æ¢
            function setCls(id, active, type) {
                document.getElementById(id).className = "key-badge " + (active ? type : "");
            }
            setCls('k1', state.mode===1, 'mode-active');
            setCls('k2', state.mode===2, 'mode-active');
            
            var isS1 = state.mode===1;
            setCls('k3', (isS1 && state.shape===0) || (!isS1 && state.particleType===0), 'sub-active');
            setCls('k4', (isS1 && state.shape===1) || (!isS1 && state.particleType===1), 'sub-active');
            setCls('k5', (isS1 && state.shape===2) || (!isS1 && state.particleType===2), 'sub-active');
            
            setCls('kq', state.color===0, 'mode-active');
            setCls('kw', state.color===1, 'mode-active');
            setCls('ke', state.color===2, 'mode-active');
            setCls('k0', state.bgBlack, 'bg-active');
            
            // é‡æ–°ç”Ÿæˆç¼“å­˜ä»¥åº”ç”¨æ–°é¢œè‰²
            generateCache();
        }

        function bindKey(id, cb) {
            var el = document.getElementById(id);
            el.onclick = cb;
            el.ontouchstart = function(e) { e.preventDefault(); cb(); };
        }

        bindKey('k1', function(){ state.mode=1; state.bgBlack=false; updateUI(); });
        bindKey('k2', function(){ state.mode=2; state.bgBlack=true; s2Data.state='IDLE'; updateUI(); });
        
        bindKey('k3', function(){ if(state.mode===1) state.shape=0; else { state.particleType=0; s2Data.state='IDLE'; } updateUI(); });
        bindKey('k4', function(){ if(state.mode===1) state.shape=1; else { state.particleType=1; s2Data.state='IDLE'; } updateUI(); });
        bindKey('k5', function(){ if(state.mode===1) state.shape=2; else { state.particleType=2; s2Data.state='IDLE'; } updateUI(); });

        bindKey('kq', function(){ state.color=0; updateUI(); });
        bindKey('kw', function(){ state.color=1; updateUI(); });
        bindKey('ke', function(){ state.color=2; updateUI(); });
        bindKey('k0', function(){ state.bgBlack = !state.bgBlack; updateUI(); });

        // å¯åŠ¨ç‚¹
        initApp();

    </script>
</body>
</html>